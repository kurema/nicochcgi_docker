# 20190311
## チャンネル動画の暗号化
hls、master.m3u8、playlist.m3u8、*.tsのダウンロードには対応した。
でもffmpegでいろいろやってもエラーになる。
hlsファイルを差し替えると大量エラーになる事からして、多分ある程度はあってる。

とりあえず暗号化動画のダウンロードは失敗するようにしておいた。

一応、こちらを参考にもしました。
[チャンネル動画の暗号化に対応](https://github.com/tor4kichi/Hohoema/issues/778)

変換は単純に、

```
ffmpeg -allowed_extensions ALL -i "playlist.m3u8" -c copy "out.ts"
```

で問題ない。
しかし以下のエラーが出る。

```
[aac @ 0xdf1900] More than one AAC RDB per ADTS frame is not implemented. Update your FFmpeg version to the newest one from Git. If the problem still occurs, it means that your file has a feature which has not been implemented.
```

FFmpegのバージョンが古いらしい。
…と思ったがやはり違う。
サーバーにおいてブラウザで開いてみると、``DEMUXER_ERROR_COULD_NOT_OPEN``が出てくる。
Vivaldiも中身はffmpegだったんだ…。
普通のffmpegと同じようなエラー。
…そんな事しなくても、デベロッパーツールのコンソールで
```
document.querySelector("video").src="https://*.dmc.nico/hlsvod/ht2_nicovideo/*"
```
で普通に止まる事は確認できる。

appendBuffer()的な何かをしてらっしゃるようだ。

てことはMedia Source Extensions的な何かでストリームを暗号化してるとかそんなのかな？
わけわかめ。
[参考](https://www.html5rocks.com/ja/tutorials/eme/basics/)。

[hls.js](https://github.com/video-dev/hls.js)ってのを使っているようだ。
何と、MPEG2 TSファイルをMP4に変換して無理やりHLSを非対応環境でも再生してしまうという。
何と乱暴な。

でも特に手を加えているようにも見えず、普通に暗号化しているはず。
それなら何故上手くいかない？

…で見てみたらなんとbinmodeを忘れてた。
それでどっか壊れたのか。
でも、binmodeを入れ直してもやっぱり駄目な感じ。
そもそも普通の動画キャッシュにbinmode使ってないんだから関係あるわけないわ。

確認したら720pが取れてた。
HLSではなくHTTPだし今更だが。
ちょっと嬉しいが容量がシャレにならん。

## チャンネル動画の暗号化 #2
試してみると鍵はアクセスごとに変わる。
tsは動画ページでJsonを取得毎にしか変わらない。

ランダムな文字列(16Byte)を鍵にするとffmpegはエラーを吐くが、同じアドレスで取得できる鍵はどれでもエラーを吐かない。
良く分からんが、チェックサム的な事で弾かれてるだけなのかもしれん。
ただし、別のtsファイルの時に取得した鍵は効かなかった。
単純に同じファイルに対して複数の鍵が使用できるというだけなのか？

もしかして"key_uri"はダミーで実際の鍵は"encrypted_key"とか？

それよりhohoemaが再生に成功しているのを確認したので、そちらが参考になるかもしれない。
Issueにヒントだけ書いてあってソースコードは2カ月前だが。
