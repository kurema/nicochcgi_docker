# 20190310
## 新仕様動画
動画取得もHTML5形式に合わせて``div#js-initial-watch-data["data-api-data"]``を参照するようにした。
~~ただし、取得は依然Smileサーバーなので画質向上はない。
getflvを回避しただけ。~~
新方式で取得するようにしたはず。

一方で古いflvやswf形式の動画は取得できなくなったはず。
チャンネル動画では見た事ないけどねそんなの。
~~一応、getflvにフォールバックできるようにした方が良いかもしれない。
少ししんどいので後回し。~~
フォールバックするようにした。
ただテストが不十分できちんと動くかは自信がない。
バグがあるかも。

~~動画取得も新仕様対応にした方が良いかもしれない。
[参考](https://qiita.com/tor4kichi/items/91550a71119f3878bfba)。
ただ、結構しんどい。ハートビートはともかく、RTSP over HTTPって手軽に扱えるのか？
540p動画は普通に欲しいけど。~~
RTSP over HTTPなのかはよくわからん。
単なるRange Accessで動いてる。

別にしんどくなかったからやってみた。
エコノミータイムなのでテストは明日以降。
~~ハートビートはやってない。~~

ハートビートしないとやっぱりダウンロードが途中で停止する。
というわけでハートビートを送るようにしました。
実際の挙動を参考に40秒ごと。

## 新仕様動画に対応
纏めると、新仕様でキャッシュするようにしました。
テストは…かなり怪しいが。
新仕様で拾えない動画やflv動画でどういう挙動をするかは大変疑わしい。
40秒ごとにpingも打つようにしてからは途中で止まらないっぽい。

他にもまだかなり怪しい点はある。
動画が最高画質で読み込まれているのかなんだか良く分からん(単純に要素数比較でやってる)。
自動で低画質の動画が降ってきたらどうやって判定すりゃええんや。

それなりのテストは明日以降。
サーバー側の仕様変更にも追従しやすいきちんとした対処をしたい。
そもそも"watch/"にJson仕込むっていうのがAPIとして不安定に見える。
その辺はチャンネル動画の取得方法からして今更だけどね。

## commentproxy.cgi
``commentproxy.cgi``の対応も雑だった。
きちんとJsonを見て要求するようにしました。

というか、コメントが表示されない動画があった。
具体的には[ARIA The ANIMATION 第１話「その 素敵な奇跡を・・・」](https://www.nicovideo.jp/watch/1425466769)。

まだ雑な点はあって、``isThreadkeyRequired``が``true``で``isLeafRequired``が``false``の場合は想定していない。

多分こんな感じ([参考](https://stackoverrun.com/ja/q/10888105))。
```
ffmpeg -i playlist.m3u8 -c copy -bsf:a aac_adtstoasc -hls_key_info_file key_info temp.mp4 
```


## インデント
インデントがいろいろ揃ってないのは分かってる。
基本、サーバー上のnanoで書いてるのでインデントは手作業なんです。
入力補助なくても即動くのは独特の楽しさがある。

もちろん本番環境。
困ったらローカルのファイルやgitを参照するという。
そもそもイントラサーバー一つなんだし、フォルダ二つ分けるのも面倒だし、本番環境に決まってる。

知らんけどperlのインデントを良い感じにするコマンドラインツールとかは普通にありそう。
でも気が向いた時に気が向いたように適当にインデントをそろえたり揃えなかったりしてる。
さして重要な点でもない。

## HLS
HLS対応、というか暗号化対応はどうしようか。
細切れtsファイルとか鬱陶しい。
大方、ffmpegで何とかする流れだろうな。
[musicServerCgi](https://github.com/kurema/musicServerCgi)でそんなような事をした覚えがある。

暗号鍵とかは普通に動画情報ページのJsonに入ってたようだが。
具体的には``video.dmcInfo.encryption.hls_encryption_v1``に何かが入ってる。

## メモ
一々perlを使わなくても、JavaScriptのConsoleで以下のコマンドを使えばAPIのJsonは読める。

```
JSON.parse(document.getElementById("js-initial-watch-data").getAttribute("data-api-data"));
```
