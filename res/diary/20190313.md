# 20190313
## Abema TV #1
ちなみにabemaだと、5秒毎くらいにm3u8も更新してる(更新しなくても30秒分くらいは同じm3u8を使える)。
本来ストリーミング向けのHLSとしてはこれが正しい。
で、鍵は下みたいな感じで独自URLスキーマで書いてある。
```
#EXT-X-KEY:METHOD=AES-128,URI="abematv-license://...",IV=0x...
```

HTML 5で独自URLスキーマってどうやってるんだろうという感じだけど、``XMLHttpRequest();``でアクセスしてみると普通に16バイトが帰ってきた。鍵って事だ。
```
var xhr=new XMLHttpRequest();xhr.onload = function(){console.log(this.proxy.response);};xhr.open("GET","abematv-license://EYkgxWe4V3vNjoEGfvwA4Q");xhr.send();
```
何回アクセスしても同じ。まぁブラウザ上だし。
そして普通にブラウザが鍵を取得できるって事でもある。
少なくとも生の鍵をサーバーから取得しているような気配がない事からしてニコニコのやり方よりはるかに上等。
サイバーエージェントの癖に…。

まぁAbema TVをわざわざ録画しようとは思わん。
公式クライアントも割合良いし、録画したいものもない。
ニュースは見るけど、ニュース録画してもなぁって話で。

細かな事を言えば、THEOplayerってのを使ってるらしい。
暗号化機能もあるね。
ぶっちゃけ機能一覧を見る限りうちのplay.htmlとどっこいというか、自慢する程でもない事を自慢してるけど、鍵周りはややこしい事やってるだろうな。
ややこしいといっても技術力からして大したことはやってない気がする。
しかし技術すごいのかと思ったら買ってきたやつかつまらん。
しかもオプソとかではないという。
…どうでもいいけどメンテナンス情報をやたら送りまくってんな。
バグじゃねぇかコレ？

ちなみにWideVineとかPlayReadyみたいなのはやってないみたい。
(追記：よく見てみたら両社ともサポートしてると使うらしい。)
普通のDRMってのはバイナリで実装を秘匿したり鍵を分からないように埋め込んだりそういうのだと思うんだけど、
今時はJavaScriptで難読化すりゃえぇというもんらしい。
まぁ普通にスクショ取れるんだからあんまり考えても仕方ない。

さらに生の鍵をそのまま渡しているとは思わないよね。
せめてJavaScriptでトリッキーな事やってると思うよね。
ニコニコ側で深読みして鍵がダミーなんじゃないかとか、hls.jsで何か怪しい事やってるんじゃないか、と思った自分を責められない。
完全に深読みだったけど。
バージョン更新で追従できなくなるような事もするわけないし。
逆にまんま分かりやすいやり方でもなく、認証しなけりゃ偽物の鍵を渡してくるってのが嫌らしい。

もしかすると今後さらなる嫌がらせで更新してくるかもしれない。
あんまりややこしい事をされると追従できん。

## Abema TV #2
もう少し見てみると、鍵は``https://license.abema.io/abematv-hls?t=*``を経由してるっぽ。
実際、``abematv-license://EYkgxWe4V3vNjoEGfvwA4Q``を少し変えて``XMLHttpRequest();``してみると上のサーバーにPOSTして500が返ってくるから間違いなくそういう事。
アドレスは変わらない。
ちなみにそのコンソールのtraceから見ると、単純にXMLHttpRequestをオーバーライドしてるのかな？
ならブラウザのネイティブのHLSならそういうのは無視するのじゃないかね？
また``hls.js``みたいなのを使ってるのか、THEOPlayerがそこまで高機能なのか…それはなさそうだ。

ニュースにも飽きたので今日はもうやめ。
