<!DOCTYPE html>

<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>ニコニコ動画プレイヤー</title>
    <style type="text/css">
      a.button{display: inline-block;padding: 0.3em 0.5em;text-decoration: none;background: #888;color: #FFF;border-radius: 3px;}
    </style>
  </head>
  <body style="background-color:black;margin:0;overflow:hidden;">
    <div id="VideoPlayer" style="margin:0 auto;position:relative;" >
      <video style="position:absolute;z-index:1;" autoplay controls>
      </video>
      <canvas style="margin:0 auto;top:0;position:absolute;z-index:2;background:transparent;pointer-events: none;" width="855" height="481">
      </canvas>
    </div><!--
　　--><div id="controler">
      <a class="button" href="javascript:void(0);" onclick="ToggleFullScreen()">サイズ切り替え</a>
      <a class="button" id="toggle_fullscreen" href="javascript:void(0);" onclick="SetFullScreen()">全画面</a>
      <a class="button" id="toggle_comment" href="javascript:void(0);" onclick="ToggleComment()">コメント非表示</a>
      <a class="button" href="javascript:void(0);" onclick="ToggleBackground()">背景切替</a>
    </div>
    <script>
//<![CDATA[
      CommentSource="";
      ShowComment=true;
      SetFromLocationHash();
      DarkBackground=true;
      FullScreenSetting=1;
      ApplyFullScreenSetting();
      window.addEventListener('resize',function(event){ApplyFullScreenSetting();});
      function SetFullScreenCancel(){
        exitFullscreen();
        var btn=document.getElementById("toggle_fullscreen");
        btn.onclick=SetFullScreen;
      }
      function SetFullScreen(){
        requestFullscreen();
        FullScreenSetting=2;
        ApplyFullScreenSetting();
        var btn=document.getElementById("toggle_fullscreen");
        btn.onclick=SetFullScreenCancel;
      }
      function requestFullscreen() {
        var target=document.body;
        if (target.webkitRequestFullscreen) {
          target.webkitRequestFullscreen();
        } else if (target.mozRequestFullScreen) {
          target.mozRequestFullScreen();
        } else if (target.msRequestFullscreen) {
          target.msRequestFullscreen();
        } else if (target.requestFullscreen) {
          target.requestFullscreen();
        }
      }
      function exitFullscreen() {
        if (document.webkitCancelFullScreen) {
          document.webkitCancelFullScreen();
        } else if (document.mozCancelFullScreen) {
          document.mozCancelFullScreen();
        } else if (document.msExitFullscreen) {
          document.msExitFullscreen();
        } else if(document.cancelFullScreen) {
          document.cancelFullScreen();
        } else if(document.exitFullscreen) {
          document.exitFullscreen();
        }
      }
      function ToggleFullScreen(){
        FullScreenSetting=(FullScreenSetting+1)%3;
        ApplyFullScreenSetting();
      }
      function ApplyFullScreenSetting(){
        if(FullScreenSetting==1){SetSizeFullFixed();}
        else if(FullScreenSetting==2){SetSizeFull();}
        else{SetSizeDefault();}
      }
      function SetSizeFull(){
        var w=window.innerWidth;
        var h=window.innerHeight;
        var hc=document.getElementById("controler").offsetHeight;
        SetSize(w,h-hc);
      }
      function SetSizeFullFixed(){
        var w=window.innerWidth;
        var h=window.innerWidth/855*481;
        var hc=document.getElementById("controler").offsetHeight;
        if(h+hc>window.innerHeight){
          h=window.innerHeight-hc;
          w=h/481*855;
        }
        SetSize(w,h);
      }
      function SetSizeDefault(){
        SetSize(855,481);
      }
      function SetSize(width,height){
        var videoDiv1= document.getElementById("VideoPlayer");
        var controler1= document.getElementById("controler");
        var canvas1=document.getElementsByTagName("canvas")[0];
        var video1=document.getElementsByTagName("video")[0];

        videoDiv1.style.width=width+"px";
        canvas1.style.width=width+"px";
        video1.style.width=width+"px";
        video1.width=width;
//        canvas1.width=width;

        videoDiv1.style.height=height+"px";
        canvas1.style.height=height+"px";
        video1.style.height=height+"px";
        video1.height=height;
        canvas1.height=canvas1.width*height/width;
      }
      function ToggleBackground(){
        DarkBackground=!DarkBackground;
        if(DarkBackground){document.body.style.backgroundColor="black";}
        else{document.body.style.backgroundColor="white";}
      }
      function ToggleComment(){
        ShowComment=!ShowComment;
        if(!ShowComment){
          document.getElementById("toggle_comment").innerText="コメント表示";
          var canvas1=document.getElementsByTagName("canvas")[0];
          var context1=canvas1.getContext('2d');
          context1.clearRect(0,0,canvas1.width,canvas1.height);
        }
        else{document.getElementById("toggle_comment").innerText="コメント非表示";}
      }
      function SetFromLocationHash(){
        //動画・コメントプロキシの設定はここを変更してください。
        var hash=window.location.hash.split(":");
        var id=hash[0].slice(1);
        CommentSource="commentproxy.cgi?id="+id;
        var video1=document.getElementsByTagName("video")[0];
        video1.src="movie.cgi?c="+hash[1]+"&v="+id;
      }
      function WriteComment(){
        if(!ShowComment){return;}
        var canvas1=document.getElementsByTagName("canvas")[0];
        var video1=document.getElementsByTagName("video")[0];
        var context1=canvas1.getContext('2d');
        context1.clearRect(0,0,canvas1.width,canvas1.height);
        var height=30;
        var time=video1.currentTime;
        var uecnt=[];
        var shitacnt=[];
        context1.font=height+"px 'ＭＳ ゴシック'";
	        
        var cmDuration=400;//コメントが表示される時間を変更するにはここを変更。10msec単位。
        var occupiedPlaces=[];
//        for(var i=Comments.length-1;i>=0;i--){
        for(var i=0;i<Comments.length;i++){
          var comment=Comments[i];
          if(time * 100-cmDuration<comment.vpos && comment.vpos < time *100 +cmDuration*0){
//          if(comment.vpos < time *100 +cmDuration*2){
            var occupiedPlace=function(rx,y,width,height,orgx,p){
              this.x=rx;
              this.y=y;
              this.width=width;
              this.height=height;
              this.orgx=x;
              this.p=p;
            };

            var heightScale=1;
            if(comment.mail!=null && ContainsCommand(comment.mail,"small")){heightScale=0.6;}
            else if(comment.mail!=null && ContainsCommand(comment.mail,"big")){heightScale=1.5;}
            context1.font=(height*heightScale)+"px 'ＭＳ ゴシック'";

            r=new Coordinate(0,0);
            if(comment.width<0){comment.width=context1.measureText(comment.text).width;}
            if(comment.mail!=null && ContainsCommand(comment.mail,"ue")){
              r=new Coordinate(canvas1.width/2.0-comment.width/2.0,0);
              var j=0;
              if(comment.lastY>=0){
                r.y=comment.lastY;
                j=comment.lastCnt;
              }
              while(uecnt[j]==true){
                r.y+=height;
                j++;
              }
              comment.lastY=r.y;
              comment.lastCnt=j;
              uecnt[j]=true;

              if(comment.width>canvas1.width){
                heightScale*=canvas1.width/comment.width;
                context1.font=(height*heightScale)+"px 'ＭＳ ゴシック'";
                comment.width=canvas1.width;
              }
            }
            else if(comment.mail!=null && ContainsCommand(comment.mail,"shita")){
              r=new Coordinate(canvas1.width/2.0-comment.width/2.0,0);
              var j=0;
              if(comment.lastY>=0){
                r.y=comment.lastY;
                j=comment.lastCnt;
              }
              while(shitacnt[j]==true){
                r.y+=height;
                j++;
              }
              comment.lastY=r.y;
              comment.lastCnt=j;
              shitacnt[j]=true;

              r.y=canvas1.height-r.y-height;

              if(comment.width>canvas1.width){
                heightScale*=canvas1.width/comment.width;
                context1.font=(height*heightScale)+"px 'ＭＳ ゴシック'";
                comment.width=canvas1.width;
              }

            }else{
              var p=((comment.vpos-time * 100)/cmDuration)+1;
              var x=p*canvas1.width-comment.width;
              var r=GetFromOccupied(occupiedPlaces,x,comment.lastY,comment.width,height,p,canvas1.height);
              comment.lastY=r.y;
              occupiedPlaces.push(new occupiedPlace(r.x,r.y,comment.width,height,x,p));
              //if(r.x>canvas1.width){next;}
            }

            r.y=Math.floor((r.y%canvas1.height)/height)*height;
            // コメントでバックスラッシュを意図しているが、円マークで表示される事があるので対策。
            // フォント切り替えなしでは全角しかないようなのでコメントアウト中。
            //var commenttext=comment.text.replace("\\","＼");
            var commenttext=comment.text;
            context1.fillStyle=GetColorFromMail(comment.mail);
            context1.fillText(commenttext,r.x,r.y+height);
            context1.strokeStyle ="#000";
            context1.strokeText(commenttext,r.x,r.y+height);
          }
        }
      }
      function ContainsCommand(mail,key){
        if(mail==null || mail==""){return false;}
        var mails=mail.spliy(" ");
        for(var i=0;i<mails.length;i++){
          if(mails[i]==key){return true;}
        }
        return false;
      }
      function GetColorFromMail(mail){
        if(mail==null || mail==""){return "#ffffff";}
        if(ContainsCommand(mail,"black")){return "#000000";}
        if(ContainsCommand(mail,"red")){return "#ff0000";}
        if(ContainsCommand(mail,"pink")){return "#FF8080";}
        if(ContainsCommand(mail,"orange")){return "#FFC000";}
        if(ContainsCommand(mail,"yellow")){return "#FFFF00";}
        if(ContainsCommand(mail,"green")){return "#00FF00";}
        if(ContainsCommand(mail,"cyan")){return "#00FFFF";}
        if(ContainsCommand(mail,"blue")){return "#0000ff";}
        if(ContainsCommand(mail,"purple")){return "#c000ff";}
        if(ContainsCommand(mail,"white")){return "#ffffff";}

        if(ContainsCommand(mail,"white2") || ContainsCommand(mail,"niconicowhite")){return "#cccc99";}
        if(ContainsCommand(mail,"red2") || ContainsCommand(mail,"truered")){return "#cc0033";}
        if(ContainsCommand(mail,"pink2")){return "#ff33cc";}
        if(ContainsCommand(mail,"orange2") || ContainsCommand(mail,"passionorange")){return "#ff6600";}
        if(ContainsCommand(mail,"yellow2") || ContainsCommand(mail,"madyellow")){return "#999900";}
        if(ContainsCommand(mail,"green2") || ContainsCommand(mail,"elementalgreen")){return "#00cc66";}
        if(ContainsCommand(mail,"cyan2")){return "#00cccc";}
        if(ContainsCommand(mail,"blue2") || ContainsCommand(mail,"marineblue")){return "#3399ff";}
        if(ContainsCommand(mail,"purple2") || ContainsCommand(mail,"nobleviolet")){return "#6633cc";}
        if(ContainsCommand(mail,"black2")){return "#666666";}
        
        return "#ffffff";
      }
      function Coordinate(x,y){this.x=x;this.y=y;}
      function GetFromOccupied(occupieds,x,y,w,fontHeight,p,canvasHeight){
        if(y<0){y=0;}
        //var cord=function(x,y){this.x=x;this.y=y;}
        //if(y>0){return new cord(x,y);}
        var result=new Coordinate(x,y);
        var checked=false;
        for(var i=0;i<occupieds.length;i++){
          var current=occupieds[i];
          if(current.y-fontHeight<result.y && result.y<current.y+fontHeight){
            if(current.orgx<result.x+w*2 && result.x< current.orgx+current.width*2){
              i=0;
              if(!checked && result.y!=0){
                //result.y=0;
                result.y-=fontHeight;
                checked=true;
              }else{
                result.y+=fontHeight;
                checked=true;
              }
            }
          }
        }
        result.x+=w*p;
        //if(result.y>canvasHeight){result.y=Math.floor(Math.random()*canvasHeight/fontHeight)*fontHeight;}
        //if(result.y>canvasHeight){result.y=Math.floor(canvasHeight/fontHeight-1)*fontHeight;}
        //result.y=Math.floor((result.y%canvasHeight)/fontHeight)*fontHeight;
        //result.y=(result.y%canvasHeight);
        return result;
      }
      function ParseComment(xml){
        var result=[];
        var parser = new DOMParser();
        var dom=parser.parseFromString(xml, 'text/xml');
        var chats=dom.getElementsByTagName("chat");
        for(var i=0 ; i < chats.length;i++){
          var chat=function(text,vpos,mail){
            this.text=text;
            this.vpos=vpos;
            this.mail=mail;
            this.lastY=-1;
            this.width=-1;
            this.lastCnt=-1;
          }
          var chatT=chats[i];
          var atdeleted=chats[i].getAttribute("deleted");
          if(atdeleted==0 || atdeleted==null){
            result.push(new chat(chats[i].textContent,chats[i].getAttribute("vpos"),chats[i].getAttribute("mail")));
          }
        }
        result.sort(function(a,b){return a.vpos-b.vpos;});
        return result;
      }
      function GetChatXML(callback){
        var req = new XMLHttpRequest();
        req.onreadystatechange = function() {
          if (req.readyState == 4) {
            if (req.status == 200) {
              callback(req.responseText);
              }
            }
          }
        req.open('GET',CommentSource,true);
        req.send(null);
      }
      Comments="";
      GetChatXML(function(xml) {
        Comments=ParseComment(xml);
        setInterval('WriteComment()',33);//描画間隔。30fpsで33、60fpsで16など。
      }
);
//]]>
    </script>
  </body>
</html>

