<!DOCTYPE html>

<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <title>ニコニコ動画プレイヤー</title>
    <style type="text/css">
      a.button{display: inline-block;padding: 0.3em 1em;text-decoration: none;color: #FFF; vertical-align: middle;}
      a.button_full{display: inline-block;padding: 0.7em 0.7em;text-decoration: none;
        color:rgba(255,255,255,0.5);background:rgba(0,0,0,0.0);border:0.1vw solid rgba(127,127,127,0.3);font-size:10vw;}
      #contextmenu{display: none;color:white;position:absolute;z-index:5;top:0;left:0;background-color:black;border:1px solid #888;margin:0;
        text-overflow: ellipsis;overflow: hidden;white-space: nowrap;}
      #contextmenu p.title{margin:0.3em;margin-bottom:0;font-weight: bold;}
      #contextmenu p.menu{margin:0 0.3em;cursor: pointer;display: block;}
      #contextmenu.show{display: block;text-decoration:none;}
    </style>
  </head>
  <body style="background-color:black;margin:0;overflow:hidden;">
    <div id="VideoPlayer" style="margin:0 auto;position:relative;" >
      <video style="position:absolute;z-index:1;" autoplay controls onplay="ResizeOnPlay();" onpause="ResizeOnPause();" onvolumechange="VolumeChange(this);" oncanplay="/*HideFullScreenCenter();*/">
      </video>
      <canvas style="margin:0 auto;top:0;position:absolute;z-index:2;background:transparent;pointer-events: none;" width="855" height="481">
      </canvas>
      <div style="pointer-events:none;margin:0 auto;top:0;position:relative;z-index:3;background:transparent;width:100%;height:100%;">
        <a class="button_full" id="toggle_fullscreen_center" href="javascript:void(0);" onclick="HideFullScreenCenter();ToggleFullScreenStatus();return false;" 
          style="top:50%;position:absolute;transform:translateY(-50%) translateX(-50%);left:50%;pointer-events:auto;">全画面</a>
      </div>
      <div id="contextmenu">
      </div>
      <div id="controller" style="top:70%;position:absolute;transform:translateY(-50%) translateX(-50%);left:50%;pointer-events:auto;z-index:4;background-color:black;">
        <a class="button" href="javascript:void(0);" onclick="ToggleFullScreen()" title="画面サイズ">
          <svg version="1.0" id="_x30_" xmlns="&ns_svg;" xmlns:xlink="&ns_xlink;" width="20" height="20"
	    viewBox="0 0 11.339 11.339" overflow="visible" enable-background="new 0 0 11.339 11.339" xml:space="preserve">
	    <polyline fill="none" stroke="#FFFFFF" stroke-width="0.7" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="500" points="
	 	7.371,7.937 9.638,5.669 7.371,3.401 "/>
	    <polyline fill="none" stroke="#FFFFFF" stroke-width="0.7" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="500" points="
	 		3.969,3.401 1.701,5.669 3.969,7.937 "/>
	    <line fill="none" stroke="#FFFFFF" stroke-width="0.7" stroke-linejoin="round" stroke-miterlimit="500" x1="1.701" y1="5.669" x2="9.638" y2="5.669"/>
	  </svg>
        </a>
        <a class="button" id="toggle_fullscreen" href="javascript:void(0);" onclick="ToggleFullScreenStatus()" title="フルスクリーン(F)">
          <svg  version="1.0" id="_x30_" xmlns="&ns_svg;" xmlns:xlink="&ns_xlink;" width="20" height="20"
             viewBox="0 0 11.338 11.339" overflow="visible" enable-background="new 0 0 11.338 11.339" xml:space="preserve">
            <polyline fill="none" stroke="#FFFFFF" stroke-width="0.7" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="500" points="
              4.536,9.638 1.701,9.638 1.701,6.803 "/>
            <line fill="none" stroke="#FFFFFF" stroke-width="0.7" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="500" x1="1.701" y1="9.638" x2="4.908" y2="6.431"/>
            <polyline fill="none" stroke="#FFFFFF" stroke-width="0.7" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="500" points="
              9.638,6.803 9.638,9.638 6.804,9.638 "/>
            <line fill="none" stroke="#FFFFFF" stroke-width="0.7" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="500" x1="9.638" y1="9.638" x2="6.431" y2="6.431"/>
            <polyline fill="none" stroke="#FFFFFF" stroke-width="0.7" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="500" points="
              4.536,1.701 1.701,1.701 1.701,4.535 "/>
            <line fill="none" stroke="#FFFFFF" stroke-width="0.7" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="500" x1="1.701" y1="1.701" x2="4.908" y2="4.908"/>
            <polyline fill="none" stroke="#FFFFFF" stroke-width="0.7" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="500" points="
              9.638,4.535 9.638,1.701 6.804,1.701 "/>
            <line fill="none" stroke="#FFFFFF" stroke-width="0.7" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="500" x1="9.638" y1="1.701" x2="6.431" y2="4.908"/>
       	  </svg>
        </a>
        <a class="button" id="toggle_comment" href="javascript:void(0);" onclick="ToggleComment()" title="コメント(C)">
          <svg  version="1.0" id="_x30_" xmlns="&ns_svg;" xmlns:xlink="&ns_xlink;" width="20" height="20"
            viewBox="0 0 11.338 11.339" overflow="visible" enable-background="new 0 0 11.338 11.339" xml:space="preserve">
            <polyline fill="none" stroke="#FFFFFF" stroke-width="0.7" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="500" points="
            3.402,7.937 1.702,7.937 1.702,1.701 9.638,1.701 9.638,7.937 5.103,7.937 3.402,9.638 3.402,7.937 "/>
          </svg>
        </a>
        <!--<a class="button" href="javascript:void(0);" onclick="ToggleBackground()">背景</a>-->
        <a class="button" id="toggle_fps" href="javascript:void(0);" onclick="ToggleFps()" title="コメント描画頻度">fps</a>
        <a class="button" id="nicovideo_link" onclick="return ! OpenInNicovideo();" style="display:none;" href="https://www.nicovideo.jp/watch/" title="ニコニコ動画で見る">
          <svg version="1.0" id="_x30_" xmlns="&ns_svg;" xmlns:xlink="&ns_xlink;" width="20" height="20" viewBox="0 0 11.34 11.339" overflow="visible" enable-background="new 0 0 11.34 11.339" xml:space="preserve">
            <circle fill="none" stroke="#FFFFFF" stroke-width="0.7" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="500" cx="5.67" cy="5.669" r="3.969"/>
            <line fill="none" stroke="#FFFFFF" stroke-width="0.7" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="500" x1="1.701" y1="5.669" x2="9.639" y2="5.669"/>
            <path fill="none" stroke="#FFFFFF" stroke-width="0.7" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="500" d="M5.67,1.701c-1.512,2.43-1.512,5.507,0,7.938"/>
            <path fill="none" stroke="#FFFFFF" stroke-width="0.7" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="500" d="M5.67,9.638c1.512-2.43,1.512-5.508,0-7.938"/>
            <path fill="none" stroke="#FFFFFF" stroke-width="0.7" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="500" d="M2.413,3.401c1.908,1.512,4.605,1.512,6.514,0"/>
            <path fill="none" stroke="#FFFFFF" stroke-width="0.7" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="500" d="M8.927,7.937c-1.908-1.512-4.605-1.512-6.514,0"/>
          </svg>
        </a>
        <span id="message" style="color:#888;text-align:center;"></span>
      </div>
    </div>
    <script>
//<![CDATA[
      var CanvasMessage="";
      var CanvasMessageDeadline=0;
      var CommentTimer;
      var ChennelId;
      var MovieId;
      var CommentDuration=500;//コメントが表示される時間を変更するにはここを変更。10msec単位。
      CommentSource="";
      ShowComment=localStorage.getItem("niconico_comment_enabled")?localStorage.getItem("niconico_comment_enabled")=="true":true;
      ShowComment=!ShowComment;
      ToggleComment();
      SetFromLocationHash();
      Background=localStorage.getItem("niconico_background")?localStorage.getItem("niconico_background"):"black";
      ApplyBackgroundSetting();
      FullScreenSetting=2;
      ApplyFullScreenSetting();
      window.addEventListener('resize',function(event){ApplyFullScreenSetting();});
      var OriginalCoord;
      SetTouchEvent();
      var Fps=localStorage.getItem("niconico_comment_Fps")?parseFloat(localStorage.getItem("niconico_comment_Fps")):30;
      SetFpsDisplay();
      setTimeout(function(){HideFullScreenCenter();},3000);
      SetControllerVisibility(false);
      
      document.getElementsByTagName("video")[0].addEventListener("contextmenu", function(e){
        var canvas1=document.getElementsByTagName("canvas")[0];
        var w=canvas1.width;
        var menu = document.getElementById("contextmenu");
        if(menu.classList.contains('show')) {
          menu.classList.remove('show');
        }
        while (menu.firstChild) menu.removeChild(menu.firstChild);
        for(var i=0;i<Comments.length;i++){
          var comment=Comments[i];
          if(comment.lastDisplayed && comment.lastX * w < e.offsetX && e.offsetX < comment.lastX * w + comment.lastWidth * w
            && comment.lastYReal * w < e.offsetY && e.offsetY < comment.lastYReal * w + comment.lastHeight * w
            ){
            
            var text=comment.text;
            
            var p = document.createElement('p');
            p.innerText=text.replace(/\n/g, '↵');
            p.classList.add('title');
            menu.appendChild(p);
            
            if(comment.mail!=null && comment.mail != ""){
              var m = document.createElement('p');
              m.innerText="コマンド:"+comment.mail;
              m.classList.add('menu');
              menu.appendChild(m);
            }
            
            var a = document.createElement('p');
            a.innerText="コメントをコピー";
            a.classList.add('menu');
            a.addEventListener("click", function(e){
              document.getSelection().selectAllChildren(p);
              document.execCommand("copy");  
              },false);
            menu.appendChild(a);
            
            var gg = document.createElement('p');
            gg.classList.add('menu');
            gg.innerText="コメントを検索";
            gg.addEventListener("click", function(e){
              window.open('https://www.google.co.jp/search?hl=ja&q='+encodeURI(text));
              },false);
            menu.appendChild(gg);

            menu.classList.add('show');
            menu.style.left=Math.min(e.offsetX,canvas1.width-parseInt(window.getComputedStyle(menu).width))+"px";
            console.log(e.offsetX+" "+canvas1.width+" "+window.getComputedStyle(menu).width);
            menu.style.top=e.offsetY+"px";
            
            e.preventDefault();
          }
        }
        
      },false);
      document.body.addEventListener('click',function(){
        var menu = document.getElementById("contextmenu");
        if(menu.classList.contains('show')) {
          menu.classList.remove('show');
        }
      },false);
      function HideFullScreenCenter(){
        document.getElementById("toggle_fullscreen_center").style.display="none";
      }

      function Coord(x,y){this.x=x;this.y=y;}
      document.onkeydown = function (e){
        var video1=document.getElementsByTagName("video")[0];
        if(e.keyCode==37 || e.keyCode==227 || e.key=="ArrowLeft" || e.key=="Left"){
          video1.currentTime-=10;
          ShowCurrentTime();
          e.preventDefault();
        }
        else if(e.keyCode==39 || e.keyCode==228 || e.key=="ArrowRight" || e.key=="Right"){
          video1.currentTime+=10;
          ShowCurrentTime();
          e.preventDefault();
        }
        else if(e.keyCode==38 || e.key=="ArrowUp" || e.key=="Up"){
          video1.volume=Math.min(video1.volume+0.05,1.0);
          ShowVolume();
          e.preventDefault();
        }
        else if(e.keyCode==40 || e.key=="ArrowDown" || e.key=="Down"){
          video1.volume=Math.max(video1.volume-0.05,0.0);
          ShowVolume();
          e.preventDefault();
        }
        else if(e.keyCode==32 || e.keyCode==179 || e.key=="Spacebar" || e.key==" " || e.key=="MediaPlayPause"){
          if(video1.paused){video1.play();}else{video1.pause();}
          e.preventDefault();
        }
        else if(e.key=="Play" && video1.paused){video1.play();e.preventDefault();}
        else if((e.key=="Pause" || e.key=="MediaPause") && !video1.paused){video1.pause();e.preventDefault();}
        else if(e.keyCode==67 || e.key=="c" || e.key=="ColorF2Yellow"){ToggleComment();e.preventDefault();}
        else if(e.keyCode==77 || e.key=="m"){video1.muted=!video1.muted;e.preventDefault();}
        else if(e.keyCode==70 || e.key=="f"){ToggleFullScreenStatus();e.preventDefault();}
      }
      function ShowCurrentTime(){
        var video=document.getElementsByTagName("video")[0];
        var t = video.currentTime;
        var tx = Math.floor(t/60)+":"+("00"+(Math.floor(t)%60)).slice(-2);
        SetMessageCanvas(tx,1000);
      }
      function ShowVolume(){
        var video=document.getElementsByTagName("video")[0];
        SetMessageCanvas("音量: "+Math.round(video.volume*100)+"%",1000);
      }
      function ToggleFps(){
        if(Fps==60){Fps=15;}
        else if(Fps==15){Fps=24;}
        else if(Fps==24){Fps=30;}
        else if(Fps==30){Fps=60;}
        else{Fps=60;}
        localStorage.setItem("niconico_comment_Fps",Fps);
        SetFpsDisplay();
        clearInterval(CommentTimer);
        CommentTimer=setInterval('DrawComment()', 1000.0/Fps);
      }
      function SetFpsDisplay(){
        var abutton=document.getElementById("toggle_fps");
        abutton.innerText=Fps+"Fps";
      }
      var MoveBaseTime=-1;
      function SetTouchEvent(){
        var video1=document.getElementsByTagName("video")[0];
        var target=document.body;
        video1.addEventListener('touchstart', function(event) {
          /*video1.pause();*/
          if(MoveBaseTime==-1) {MoveBaseTime=video1.currentTime;}
          OriginalCoord=new Coord(event.changedTouches[0].pageX,event.changedTouches[0].pageY);
        },false);
        video1.addEventListener('touchmove', function(event) {
          event.preventDefault();
          if(MoveBaseTime==-1) {MoveBaseTime=video1.currentTime;}
          var currentCoord=new Coord(event.changedTouches[0].pageX,event.changedTouches[0].pageY);
          SetMessage(GetSecond(currentCoord,OriginalCoord)+"秒移動");
        },false);
        video1.addEventListener('touchend', function(event) {
          var currentCoord=new Coord(event.changedTouches[0].pageX,event.changedTouches[0].pageY);
          SetMessage("");
          var sec=GetSecond(currentCoord,OriginalCoord);
          if(Math.abs(sec)>0){
            video1.currentTime=MoveBaseTime+sec;
          }
          MoveBaseTime=-1;
          /*video1.play();*/
        },false);
      }
      function SetMessage(message){
          var msgp=document.getElementById("message");
          msgp.innerText=message;
          SetMessageCanvas(message,0);
      }
      function SetMessageCanvas(message,timespan){
          //SetMessage(message);
          CanvasMessage=message;
          if(timespan!=0){
            CanvasMessageDeadline=(new Date()).getTime()+timespan;
          }else{
            CanvasMessageDeadline=0;
          }
      }
      function ResizeOnPause(){
        SetControllerVisibility(true);
        //if(FullScreenSetting==2){SetSizeFullFixed();}
        //if(FullScreenSetting==3){SetSizeFullControlable();}
      }
      function ResizeOnPlay(){
        SetControllerVisibility(false);
        //if(FullScreenSetting==2){SetSizeFullFixedUncontorolable();}
        //if(FullScreenSetting==3){SetSizeFull();}
      }
      function VolumeChange(from){
        var storage=localStorage;
        storage.setItem("niconico_volume",from.volume);
      }
      function GetSecond(orgcoord,crtcoord){
        return Math.floor(-(crtcoord.x-orgcoord.x)*0.1);
      }
      function SetControllerVisibility(visible){
        if(visible){
          document.getElementById("controller").style.display="inline";
        }else{
          document.getElementById("controller").style.display="none";
          //setTimeout(function(){document.getElementById("controller").style.display="none";},5000);
        }
      }
      function ToggleFullScreenStatus(){
        if(document.fullscreenElement == null){
          requestFullscreen();
          
          var locker = screen.lockOrientation || screen.mozLockOrientation || screen.msLockOrientation;
          if (locker != null && screen.lockOrientationUniversal("landscape")) {
          }else if(screen.orientation.lock != null){
            screen.orientation.lock("landscape").then(function(){/* Locked */},function(/* Lock failed */){});
          }
        }else{
          exitFullscreen();
        }
      }
      function requestFullscreen() {
        var target=document.body;
        if (target.webkitRequestFullscreen) {
          target.webkitRequestFullscreen();
        } else if (target.mozRequestFullScreen) {
          target.mozRequestFullScreen();
        } else if (target.msRequestFullscreen) {
          target.msRequestFullscreen();
        } else if (target.requestFullscreen) {
          target.requestFullscreen();
        }
      }
      function exitFullscreen() {
        if (document.webkitCancelFullScreen) {
          document.webkitCancelFullScreen();
        } else if (document.mozCancelFullScreen) {
          document.mozCancelFullScreen();
        } else if (document.msExitFullscreen) {
          document.msExitFullscreen();
        } else if(document.cancelFullScreen) {
          document.cancelFullScreen();
        } else if(document.exitFullscreen) {
          document.exitFullscreen();
        }
      }
      function ToggleFullScreen(){
        FullScreenSetting=(FullScreenSetting+1)%4;
        if(FullScreenSetting==1){FullScreenSetting++;}

        if(FullScreenSetting==0){SetMessageCanvas("標準サイズ",3000);}
        else if(FullScreenSetting==1){SetMessageCanvas("最適(コントローラー常時表示)",3000);}
        else if(FullScreenSetting==2){SetMessageCanvas("最適",3000);}
        else if(FullScreenSetting==3){SetMessageCanvas("全体表示",3000);}

        ApplyFullScreenSetting();
      }
      function ApplyFullScreenSetting(){
        if(FullScreenSetting==1){SetSizeFullFixed();}
        else if(FullScreenSetting==2){SetSizeFullFixedUncontorolable();}
        else if(FullScreenSetting==3){SetSizeFull();}
        else{SetSizeDefault();}
      }
      function SetSizeFull(){
        var w=window.innerWidth;
        var h=window.innerHeight;
        var hc=document.getElementById("controller").offsetHeight;
        //SetSize(w,h-hc);
        if(w/(16/9)+hc>h){SetSize(w,h);}else{SetSize(w,h-hc);}
      }
      function SetSizeFullControlable(){
        var w=window.innerWidth;
        var h=window.innerHeight;
        var hc=document.getElementById("controller").offsetHeight;
        SetSize(w,h-hc);
      }
      function SetSizeFullFixed(){
        var w=window.innerWidth;
        var h=window.innerWidth/(16/9);
        var hc=document.getElementById("controller").offsetHeight;
        if(h+hc>window.innerHeight){
          h=window.innerHeight-hc;
          w=h*(16/9);
        }
        SetSize(w,h);
      }
      function SetSizeFullFixedUncontorolable(){
        var w=window.innerWidth;
        var h=window.innerWidth/(16/9);
        var hc=document.getElementById("controller").offsetHeight;
        if(h>window.innerHeight){
          h=window.innerHeight;
          w=h*(16/9);
        }
        SetSize(w,h);
      }
      function SetSizeDefault(){
        var w=Math.min(window.innerWidth,855);
        SetSize(w,w/855.0*481.0);
      }
      function SetSize(width,height){
        var videoDiv1= document.getElementById("VideoPlayer");
        var controler1= document.getElementById("controller");
        var canvas1=document.getElementsByTagName("canvas")[0];
        var video1=document.getElementsByTagName("video")[0];

        videoDiv1.style.width=width+"px";
        canvas1.style.width=width+"px";
        video1.style.width=width+"px";
        video1.width=width;
        canvas1.width=width*window.devicePixelRatio;

        videoDiv1.style.height=height+"px";
        canvas1.style.height=height+"px";
        video1.style.height=height+"px";
        video1.height=height;
        canvas1.height=height*window.devicePixelRatio;
      }
      function ToggleBackground(){
        if(Background=="black"){Background="white";}
        else if(Background=="white"){Background="black";}
        else{Background="black";}
        ApplyBackgroundSetting();
        localStorage.setItem("niconico_background",Background);
      }
      function ApplyBackgroundSetting(){
        document.body.style.backgroundColor=Background;
      }
      function ToggleComment(){
        if(ShowComment){
          SetMessageCanvas("コメントオフ",1000);

          //document.getElementById("toggle_comment").innerText="コメントオフ";
          document.getElementById("toggle_comment").style.opacity=0.5;
          var canvas1=document.getElementsByTagName("canvas")[0];
          var context1=canvas1.getContext('2d');
          context1.clearRect(0,0,canvas1.width,canvas1.height);
        }
        else{
          //document.getElementById("toggle_comment").innerText="コメントオン";
          document.getElementById("toggle_comment").style.opacity=1.0;

          SetMessageCanvas("コメントオン",1000);
        }
        ShowComment=!ShowComment;
        localStorage.setItem("niconico_comment_enabled",ShowComment);
      }
      function SetFromLocationHash(){
        var video1=document.getElementsByTagName("video")[0];
        //IMPORTANT:
        //動画・コメントプロキシの設定はここを変更してください。
        var hash=window.location.hash.split(":");
        var id=hash[0].slice(1);
        //コメントプロキシ設定
        CommentSource="commentproxy.cgi?id="+id;
        if(hash[1]){
          ChannelId=hash[1];
          //動画アドレス設定
          video1.src="movie.cgi?c="+ChannelId+"&v="+id;
        }else{
          //動画アドレス設定
          video1.src="movie.cgi?v="+id;
        }

        UpdateLinkId(id);
        MovieId=id;

        var storage=localStorage;
        var vol=storage.getItem("niconico_volume");
        if(vol){ video1.volume= vol;}
      }
      function UpdateLinkId(id){
        var link=document.getElementById("nicovideo_link");
        link.setAttribute("href", "https://www.nicovideo.jp/watch/"+id);
        link.style.display="inline-block";
      }
      function OpenInNicovideo(){
        if(MovieId){
          var video=document.getElementsByTagName("video")[0];
          window.location.href = "http://www.nicovideo.jp/watch/"+MovieId+"?from="+Math.floor(video.currentTime);
          return true;
        }
        return false;
      }
      function CheckRanges(ranges,range){
        if(!ranges){return true;}
        for(var key in ranges){
          var tr=ranges[key];
          if(tr.a<=range.b && range.a<tr.b){return false;}
        }
        return true;
      }
      function GetActualVpos(vpos,duration,cmDuration){
        return Math.min(vpos,duration*100-cmDuration*0.5);
      }
      function DrawComment(){
        var canvas1=document.getElementsByTagName("canvas")[0];
        var video1=document.getElementsByTagName("video")[0];
        var context1=canvas1.getContext('2d');
        context1.clearRect(0,0,canvas1.width,canvas1.height);

        var height=canvas1.width/855*30;
        var time=video1.currentTime;
        var fontWeight=600;
        var fontName="";

        var blurScale=0.3;

        if(CanvasMessage!="" && (CanvasMessageDeadline==0 || CanvasMessageDeadline>=(new Date()).getTime())){
          fontName='"ヒラギノ角ゴ ProN W6", HiraKakuProN-W6, "ヒラギノ角ゴ ProN", HiraKakuProN, "Hiragino Kaku Gothic ProN"'+','+'"ＭＳ Ｐゴシック", "MS PGothic", MSPGothic, MS-PGothic'+',Arial';
          context1.font=GetFontText(height,2,fontName,fontWeight);

          var mesWidth=context1.measureText(CanvasMessage).width;

          context1.textBaseline="middle";
          context1.fillStyle="#ffffff";
          context1.shadowColor="#000000";

          context1.shadowOffsetX=0;
          context1.shadowOffsetY=0;
          context1.shadowBlur=height*blurScale;
          context1.fillText(CanvasMessage,canvas1.width/2.0-mesWidth/2.0,canvas1.height/2.0);
          context1.globalAlpha=1.0;
          fontName="";
        }
        if(!ShowComment){return;}

        context1.font=GetFontText(height,1,fontName,fontWeight);

        var range=function(a,w){this.a=a;this.b=a+w;this.w=w;}
        var rangesUe=[];
        var rangesShita=[];
	        
        var cmDuration=CommentDuration;
        var operatedComments=[];
        for(var i=0;i<Comments.length;i++){
          var comment=Comments[i];
          comment.lastDisplayed=0;
          comment.text=comment.text.replace('\t','      ');//タブをスペースに置換。
          var cvpos=GetActualVpos(comment.vpos,video1.duration,cmDuration);
          if(time * 100-cmDuration<cvpos && cvpos < time *100 +cmDuration*0){
            if(comment.mail!=null && ContainsCommand(comment.mail,"invisible")){continue;}

            var heightScale=1;
            if(comment.fontScale>0){heightScale=comment.fontScale;}
            else if(comment.mail!=null && ContainsCommand(comment.mail,"small")){heightScale=0.6;}
            else if(comment.mail!=null && ContainsCommand(comment.mail,"big")){heightScale=1.5;}

            if(comment.mail!=null && ContainsCommand(comment.mail,"mincho")){
              fontName='"ヒラギノ明朝 ProN W3", HiraMinProN-W3, "ヒラギノ明朝 ProN", HiraMinProN, "Hiragino Mincho ProN"'+','+'"游明朝体", "游明朝", "Yu Mincho", YuMincho, yumincho, YuMin-Medium'+','+"'serif'";
              fontWeight=300;
            }else if(comment.mail!=null && ContainsCommand(comment.mail,"gothic")){
              fontName='"ヒラギノ角ゴシック", "Hiragino Sans", HiraginoSans'+','+'"游ゴシック体", "游ゴシック", "Yu Gothic", YuGothic, yugothic, YuGo-Medium'+','+'sans-serif';
              fontWeight=300;
            }else{
              fontName='"ヒラギノ角ゴ ProN W6", HiraKakuProN-W6, "ヒラギノ角ゴ ProN", HiraKakuProN, "Hiragino Kaku Gothic ProN"'+','+'"ＭＳ Ｐゴシック", "MS PGothic", MSPGothic, MS-PGothic'+',Arial';
              fontWeight=600;
            }

            context1.font=GetFontText(height,heightScale,fontName,fontWeight);
            r=new Coordinate(0,0);
            var overflow=false;
            var modnum=(canvas1.height-height+1);
//            if(comment.width<0)
            comment.width=-1;
            for(var line of comment.text.split('\n'))
              {comment.width=Math.max(context1.measureText(line).width,comment.width);}
            if(comment.mail!=null && ContainsCommand(comment.mail,"ue")){
              r=new Coordinate(canvas1.width/2.0-comment.width/2.0,0);
              if(ContainsCommand(comment.mail,"ender")){}else{
              if(comment.lastY>=0){
                r.y=comment.lastY*canvas1.width;
              }
              var changed=false;
              while(! CheckRanges(rangesUe,new range(r.y,height*heightScale))){
                r.y+=height*heightScale;
                changed=true;
              }
              if(changed){
                for(var key in rangesUe){
                  var crtr=rangesUe[key];
                  if(crtr.b<r.y && CheckRanges(rangesUe,new range(crtr.b,height*heightScale))){
                    r.y=crtr.b;
                  }
                }
              }
              }
              comment.lastY=r.y/canvas1.width;
              if(comment.width>canvas1.width){
                heightScale*=canvas1.width/comment.width;
                var fsize=Math.max(height*heightScale,1);
                heightScale=fsize/height;
                context1.font=GetFontText(fsize,1,fontName,fontWeight);
                comment.width=context1.measureText(comment.text).width;
                r.x=canvas1.width/2.0 - comment.width/2.0;
              }
              if(!ContainsCommand(comment.mail,"ender")){
                rangesUe.push(new range(r.y,comment.text.split('\n').length*height*heightScale));
              }

//              r.y+=height*(heightScale-1);
              comment.lastYReal=r.y/canvas1.width;
              context1.textBaseline="top";
              if(r.y>modnum){overflow=true;r.y=r.y%modnum;}
            }
            else if(comment.mail!=null && ContainsCommand(comment.mail,"shita")){
              r=new Coordinate(canvas1.width/2.0-comment.width/2.0,(comment.text.split('\n').length-1.0)*height*heightScale);
              if(ContainsCommand(comment.mail,"ender")){}else{
              if(comment.lastY>=0){
                r.y=comment.lastY*canvas1.width;
              }
              var changed=false;
              while(! CheckRanges(rangesShita,new range(r.y,height*heightScale))){
                r.y+=height*heightScale;
                changed=true;
              }
              if(changed){
                for(var key in rangesShita){
                  var crtr=rangesShita[key];
                  if(crtr.b<r.y && CheckRanges(rangesShita,new range(crtr.b,height*heightScale))){
                    r.y=crtr.b;
                  }
                }
              }
              }
              comment.lastY=r.y/canvas1.width;

              if(comment.width>canvas1.width){
                heightScale*=canvas1.width/comment.width;
                context1.font=GetFontText(height,heightScale,fontName,fontWeight);
                comment.width=context1.measureText(comment.text).width;
                r.x=canvas1.width/2.0 - comment.width/2.0;
              }
/*
context1.rect(r.x,r.y+height,comment.width,-height*heightScale);
context1.stroke();
*/
              var lineCnt=comment.text.split('\n').length;
              if(!ContainsCommand(comment.mail,"ender")){
                rangesShita.push(new range(r.y,lineCnt*height*heightScale));
                //rangesShita.push(new range(r.y,height*heightScale));
              }

              if(r.y>modnum){overflow=true;r.y=r.y%modnum;}
              r.y=canvas1.height-r.y-(lineCnt-1)*height*heightScale;
              comment.lastYReal=(r.y-height*heightScale)/canvas1.width;

              context1.textBaseline="bottom";
            }else{
              var r=GetFromOperated(operatedComments,comment,video1.duration,cmDuration,time,canvas1.width,height,context1);
              comment.lastY=r.y/canvas1.width;
//              r.y+=height*(heightScale-1)/2.0;
              if(r.y>modnum){overflow=true;r.y=r.y%modnum;}
              r.y+=height/2.0;
              operatedComments.push(comment);
              context1.textBaseline="middle";
              comment.lastYReal=(r.y-height*heightScale/2.0)/canvas1.width;
//context1.rect(r.x,r.y,comment.width,height);
//context1.stroke();
            }
            comment.fontScale=heightScale;

            // コメントでバックスラッシュを意図しているが、円マークで表示される事があるので対策。
            // フォント切り替えなしでは全角しかないようなので\u29F5(REVERSE SOLIDUS OPERATOR)で代替
            var commenttext=comment.text.replace("\\","\u29F5");
            //var commenttext=comment.text;
            context1.globalAlpha=overflow?0.7:1.0;
            var fillColor=GetColorFromMail(comment.mail);
            context1.fillStyle=fillColor;
            if(!overflow){
              context1.shadowColor= fillColor=="#000000" ? "#ffffff" : "#000000";
            }else{
              context1.shadowColor= "transparent";
            }
            context1.shadowOffsetX=0;
            context1.shadowOffsetY=0;
            context1.shadowBlur=height*blurScale;
            
            var lines=commenttext.split('\n');
            
            comment.lastX=r.x/canvas1.width;
            comment.lastWidth=comment.width/canvas1.width;
            comment.lastHeight=height*heightScale*lines.length/canvas1.width;
            comment.lastDisplayed=1;

            var lineCnt=0;
            for(var line of lines){
              context1.fillText(line,r.x,r.y+height*heightScale*lineCnt);
              lineCnt++;
            }
            context1.globalAlpha=1.0;
          }
        }
      }
      function GetFontText(height,heightScale,fontName,fontWeight){
        return fontWeight+" "+(height*heightScale)+"px "+fontName;
      }
      function GetFromOperated(operatedComments,comment,videoDuration,cmDuration,time,canvasWidth,fontHeight,testContext){
        var cvpos=GetActualVpos(comment.vpos,videoDuration,cmDuration);
 //       if(comment.lastY>=0){return new Coordinate(GetCommentX(cvpos,time*100,comment.width,canvasWidth,cmDuration),comment.lastY*canvasWidth);}
        var ry=Math.max(0,comment.lastY*canvasWidth);
        var firstCollision=true;
        for(var i=0;i<operatedComments.length;i++){
          var opCom=operatedComments[i];
          var cvpos2=GetActualVpos(opCom.vpos,videoDuration,cmDuration);
          var a=GetCommentX(cvpos,cvpos2+cmDuration,comment.width,canvasWidth,cmDuration);
          var b=GetCommentX(cvpos2,cvpos,opCom.width,canvasWidth,cmDuration) + opCom.width;
          var c=GetCommentX(cvpos2,cvpos+cmDuration,opCom.width,canvasWidth,cmDuration);
          var d=GetCommentX(cvpos,cvpos2,comment.width,canvasWidth,cmDuration) + comment.width;
          if(
            CheckY(ry,fontHeight,opCom.lastY*canvasWidth) &&
                (! ( ( (b<canvasWidth) && (0<a) && (cvpos2<=cvpos) ) || ( (c<canvasWidth) && (0<d) && (cvpos<cvpos2) ) ) )
//                (! ( ( (b<canvasWidth) && (0<a) ) ) )
            ){
            i=-1;
            if(firstCollision){firstCollision=false;ry=0;}
            else{ry+=fontHeight;}
          }
        }
      var rx=GetCommentX(cvpos,time*100,comment.width,canvasWidth,cmDuration);
//debug
/*
if(!firstCollision){
testContext.rect(rx,ry,comment.width,fontHeight);
testContext.stroke();
}
*/
        return new Coordinate(rx,ry);
      }
      function GetCommentX(cvpos,time,width,canvasWidth,cmDuration){
        return (1-(time-cvpos)/cmDuration)*(canvasWidth+width)-width;
      }

      function ContainsCommand(mail,key){
        if(mail==null || mail==""){return false;}
        var mails=mail.split(" ");
        for(var i=0;i<mails.length;i++){
          if(mails[i]==key){return true;}
        }
        return false;
      }
      function GetColorFromMail(mail){
        if(mail==null || mail==""){return "#ffffff";}
        if(ContainsCommand(mail,"black")){return "#000000";}
        if(ContainsCommand(mail,"red")){return "#ff0000";}
        if(ContainsCommand(mail,"pink")){return "#FF8080";}
        if(ContainsCommand(mail,"orange")){return "#FFC000";}
        if(ContainsCommand(mail,"yellow")){return "#FFFF00";}
        if(ContainsCommand(mail,"green")){return "#00FF00";}
        if(ContainsCommand(mail,"cyan")){return "#00FFFF";}
        if(ContainsCommand(mail,"blue")){return "#0000ff";}
        if(ContainsCommand(mail,"purple")){return "#c000ff";}
        if(ContainsCommand(mail,"white")){return "#ffffff";}

        if(ContainsCommand(mail,"white2") || ContainsCommand(mail,"niconicowhite")){return "#cccc99";}
        if(ContainsCommand(mail,"red2") || ContainsCommand(mail,"truered")){return "#cc0033";}
        if(ContainsCommand(mail,"pink2")){return "#ff33cc";}
        if(ContainsCommand(mail,"orange2") || ContainsCommand(mail,"passionorange")){return "#ff6600";}
        if(ContainsCommand(mail,"yellow2") || ContainsCommand(mail,"madyellow")){return "#999900";}
        if(ContainsCommand(mail,"green2") || ContainsCommand(mail,"elementalgreen")){return "#00cc66";}
        if(ContainsCommand(mail,"cyan2")){return "#00cccc";}
        if(ContainsCommand(mail,"blue2") || ContainsCommand(mail,"marineblue")){return "#3399ff";}
        if(ContainsCommand(mail,"purple2") || ContainsCommand(mail,"nobleviolet")){return "#6633cc";}
        if(ContainsCommand(mail,"black2")){return "#666666";}
        
        if(mail==null || mail==""){return false;}
        var reg=new RegExp(/#[0-9A-fA-F]{6}/);
        var mails=mail.split(" ");
        for(var i=0;i<mails.length;i++){
          if(reg.test(mails[i])){return mails[i];}
        }

        return "#ffffff";
      }
      function Coordinate(x,y){this.x=x;this.y=y;}
      function CheckY(y1,fontHeight,y2){
        return y1-fontHeight/2.0 < y2 && y2 < y1+fontHeight/2.0;
      }
      function ParseComment(xml){
        var result=[];
        var parser = new DOMParser();
        var dom=parser.parseFromString(xml, 'text/xml');
        var chats=dom.getElementsByTagName("chat");
        for(var i=0 ; i < chats.length;i++){
          var chat=function(text,vpos,mail,cnt){
            this.text=text;
            this.vpos=vpos;
            if(mail!=null){
              this.mail=mail.toLowerCase();
            }else{
              this.mail=mail;
            }
            this.count=cnt;
            this.lastY=-1;
            this.width=-1;
            this.lastCnt=-1;
            this.fontScale=-1;
            //for contextmenu
            this.lastYReal=-1;
            this.lastX=-1;
            this.lastWidth=-1;
            this.lastDisplayed=0;
            this.lastHeight=-1;
          }
          var chatT=chats[i];
          var atdeleted=chats[i].getAttribute("deleted");
          if(atdeleted==0 || atdeleted==null){
            result.push(new chat(chats[i].textContent,chats[i].getAttribute("vpos"),chats[i].getAttribute("mail"),i));
          }
        }
        result.sort(function(a,b){
          if(a.vpos==b.vpos){return a.count>b.count?1:-1;}
          return a.vpos-b.vpos;
        });
        return result;
      }
      function GetChatXML(callback){
        var req = new XMLHttpRequest();
        req.onreadystatechange = function() {
          if (req.readyState == 4) {
            if (req.status == 200) {
              callback(req.responseText);
              }
            }
          }
        req.open('GET',CommentSource,true);
        req.send(null);
      }
      Comments="";
      GetChatXML(function(xml) {
        Comments=ParseComment(xml);
        CommentTimer=setInterval('DrawComment()', 1000.0/Fps);
      }
);
//]]>
    </script>
  </body>
</html>

