<!DOCTYPE html>

<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <title>ニコニコ動画プレイヤー</title>
    <style type="text/css">
      a.button{display: inline-block;padding: 0.3em 1em;text-decoration: none;color: #FFF; vertical-align: middle;}
      a.button_full{display: inline-block;padding: 0.7em 0.7em;
        text-decoration: none;
        color:rgba(255,255,255,0.1);background:rgba(0,0,0,0.0);border:0.1vw solid rgba(127,127,127,0.3);font-size:10vw;}
      #contextmenu{display: none;color:white;position:absolute;z-index:5;top:0;left:0;background-color:black;border:1px solid #888;margin:0;
        text-overflow: ellipsis;overflow: hidden;white-space: nowrap;}
      #contextmenu p.title{margin:0.3em;margin-bottom:0;font-weight: bold;}
      #contextmenu p.menu{margin:0 0.3em;cursor: pointer;display: block;}
      #contextmenu.show{display: block;text-decoration:none;}
    </style>
  </head>
  <body style="background-color:black;margin:0;overflow:hidden;">
    <div id="VideoPlayer" style="margin:0 auto;position:relative;overflow:hidden;" >
      <video style="position:absolute;z-index:1;" autoplay controls onplay="ResizeOnPlay();" onended="MovieEnded();" onpause="ResizeOnPause();" onvolumechange="VolumeChange(this);" oncanplay="/*HideFullScreenCenter();*/">
      </video>
      <canvas style="margin:0 auto;top:0;position:absolute;z-index:2;background:transparent;pointer-events: none;" width="855" height="481">
      </canvas>
      <div style="pointer-events:none;margin:0 auto;top:0;position:relative;z-index:3;background:transparent;width:100%;height:100%;">
        <a class="button_full" id="toggle_fullscreen_center" href="javascript:void(0);" onclick="HideFullScreenCenter();ToggleFullScreenStatus();return false;" 
          style="top:50%;position:absolute;transform:translateY(-50%) translateX(-50%);left:50%;pointer-events:auto;">全画面</a>
      </div>
      <div id="contextmenu">
      </div>
      <div id="controller" style="top:70%;position:absolute;transform:translateY(-50%) translateX(-50%);left:50%;pointer-events:auto;z-index:4;background-color:black;">
        <a class="button" href="javascript:void(0);" onclick="ToggleFullScreen()" title="画面サイズ">
          <svg version="1.0" id="_x30_" xmlns="http://www.w3.org/2000/svg" xmlns:	xlink="http://www.w3.org/1999/xlink" width="20" height="20"
	    viewBox="0 0 11.339 11.339" overflow="visible" enable-background="new 0 0 11.339 11.339" xml:space="preserve">
	    <polyline fill="none" stroke="#FFFFFF" stroke-width="0.7" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="500" points="
	 	7.371,7.937 9.638,5.669 7.371,3.401 "></polyline>
	    <polyline fill="none" stroke="#FFFFFF" stroke-width="0.7" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="500" points="
	 		3.969,3.401 1.701,5.669 3.969,7.937 "></polyline>
	    <line fill="none" stroke="#FFFFFF" stroke-width="0.7" stroke-linejoin="round" stroke-miterlimit="500" x1="1.701" y1="5.669" x2="9.638" y2="5.669"></line>
	  </svg>
        </a>
        <a class="button" id="toggle_fullscreen" href="javascript:void(0);" onclick="ToggleFullScreenStatus()" title="フルスクリーン(F)">
          <svg  version="1.0" id="_x30_" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="20" height="20"
             viewBox="0 0 11.338 11.339" overflow="visible" enable-background="new 0 0 11.338 11.339" xml:space="preserve">
            <polyline fill="none" stroke="#FFFFFF" stroke-width="0.7" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="500" points="
              4.536,9.638 1.701,9.638 1.701,6.803 "></polyline>
            <line fill="none" stroke="#FFFFFF" stroke-width="0.7" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="500" x1="1.701" y1="9.638" x2="4.908" y2="6.431"></line>
            <polyline fill="none" stroke="#FFFFFF" stroke-width="0.7" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="500" points="
              9.638,6.803 9.638,9.638 6.804,9.638 "></polyline>
            <line fill="none" stroke="#FFFFFF" stroke-width="0.7" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="500" x1="9.638" y1="9.638" x2="6.431" y2="6.431"></line>
            <polyline fill="none" stroke="#FFFFFF" stroke-width="0.7" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="500" points="
              4.536,1.701 1.701,1.701 1.701,4.535 "></polyline>
            <line fill="none" stroke="#FFFFFF" stroke-width="0.7" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="500" x1="1.701" y1="1.701" x2="4.908" y2="4.908"></line>
            <polyline fill="none" stroke="#FFFFFF" stroke-width="0.7" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="500" points="
              9.638,4.535 9.638,1.701 6.804,1.701 "></polyline>
            <line fill="none" stroke="#FFFFFF" stroke-width="0.7" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="500" x1="9.638" y1="1.701" x2="6.431" y2="4.908"></line>
       	  </svg>
        </a>
        <a class="button" id="toggle_comment" href="javascript:void(0);" onclick="ToggleComment()" title="コメント(C)">
          <svg  version="1.0" id="_x30_" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="20" height="20"
            viewBox="0 0 11.338 11.339" overflow="visible" enable-background="new 0 0 11.338 11.339" xml:space="preserve">
            <polyline fill="none" stroke="#FFFFFF" stroke-width="0.7" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="500" points="
            3.402,7.937 1.702,7.937 1.702,1.701 9.638,1.701 9.638,7.937 5.103,7.937 3.402,9.638 3.402,7.937 "></polyline>
          </svg>
        </a>
        <!--<a class="button" href="javascript:void(0);" onclick="ToggleBackground()">背景</a>-->
        <a class="button" id="toggle_fps" href="javascript:void(0);" onclick="ToggleFps()" title="コメント描画頻度">fps</a>
        <a class="button" id="toggle_pip" href="javascript:void(0);" onclick="TogglePictureInPicture();" title="ピクチャーインピクチャー">
          <svg  version="1.0" id="_x30_" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="20" height="20"
            viewBox="0 0 11.339 11.339" overflow="visible" enable-background="new 0 0 11.339 11.339" xml:space="preserve">
            <g>
            <path fill="#FFFFFF" d="M9.67,1.97h-8c-0.388,0-0.7,0.313-0.7,0.7v6c0,0.387,0.313,0.699,0.7,0.699h8
		c0.387,0,0.699-0.313,0.699-0.699v-6C10.369,2.283,10.057,1.97,9.67,1.97L9.67,1.97z M1.67,2.67h8v6l0,0l0,0h-8V2.67L1.67,2.67
		L1.67,2.67z"></path>
            </g>
            <rect x="5.67" y="5.419" fill="#FFFFFF" stroke="#FFFFFF" stroke-linejoin="round" width="3" height="2.25"></rect>
          </svg>
        </a>
        <a class="button" id="nicovideo_link" onclick="return ! OpenInNicovideo();" style="display:none;" href="https://www.nicovideo.jp/watch/" title="ニコニコ動画で見る">
          <svg version="1.0" id="_x30_" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="20" height="20" viewBox="0 0 11.34 11.339" overflow="visible" enable-background="new 0 0 11.34 11.339" xml:space="preserve">
            <circle fill="none" stroke="#FFFFFF" stroke-width="0.7" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="500" cx="5.67" cy="5.669" r="3.969"></circle>
            <line fill="none" stroke="#FFFFFF" stroke-width="0.7" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="500" x1="1.701" y1="5.669" x2="9.639" y2="5.669"></line>
            <path fill="none" stroke="#FFFFFF" stroke-width="0.7" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="500" d="M5.67,1.701c-1.512,2.43-1.512,5.507,0,7.938"></path>
            <path fill="none" stroke="#FFFFFF" stroke-width="0.7" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="500" d="M5.67,9.638c1.512-2.43,1.512-5.508,0-7.938"></path>
            <path fill="none" stroke="#FFFFFF" stroke-width="0.7" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="500" d="M2.413,3.401c1.908,1.512,4.605,1.512,6.514,0"></path>
            <path fill="none" stroke="#FFFFFF" stroke-width="0.7" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="500" d="M8.927,7.937c-1.908-1.512-4.605-1.512-6.514,0"></path>
          </svg>
        </a>
        <span id="message" style="color:#888;text-align:center;"></span>
      </div>
    </div>
    <script>
//<![CDATA[
      'use strict';

      function SetVideoLocation(){
        let video1=document.getElementsByTagName("video")[0];
        //IMPORTANT:
        //動画・コメントプロキシの設定はここを変更してください。
        let hash=window.location.hash.split(":");
        let id=hash[0].slice(1);
        //コメントプロキシ設定
        CommentSource="commentproxy.cgi?id="+id;
        if(hash[1]){
          let ChannelId=hash[1];
          //動画アドレス設定
          SetVideoSource("movie.cgi?c="+ChannelId+"&v="+id);
        }else{
          //動画アドレス設定
          SetVideoSource("movie.cgi?v="+id);
        }

        if(hash[2] && hash[2]=="repeat"){
          video1.loop=true;
        }else{
          video1.loop=false;
        }
        return id;
      }
      
      function SetVideoSource(src){
        let video=document.getElementsByTagName("video")[0];
        if(src!=video.getAttribute("src")){video.src=src;}
      }

      var CanvasMessage="";
      var CanvasMessageDeadline=0;
      var CommentTimer;
      var ChennelId;
      var MovieId;
      var CommentDuration=500;//コメントが表示される時間を変更するにはここを変更。10msec単位。
      var OriginalCoord;
      var Fps=localStorage.getItem("niconico_comment_Fps")?parseFloat(localStorage.getItem("niconico_comment_Fps")):30;
      var CommentSource="";
      var ShowComment=localStorage.getItem("niconico_comment_enabled")?localStorage.getItem("niconico_comment_enabled")=="true":true;
      var FullScreenSetting=1;
      var Comments="";
      var Background;

      window.onload = function() {
        Start();
        if(localStorage.getItem("niconico_volume")) document.getElementsByTagName("video")[0].volume=localStorage.getItem("niconico_volume");
        Background=localStorage.getItem("niconico_background")?localStorage.getItem("niconico_background"):"black";
        ApplyBackgroundSetting();
        ApplyFullScreenSetting();
        window.addEventListener('resize',function(event){
          ApplyFullScreenSetting();
          });
        SetTouchEvent();
        SetFpsDisplay();
        setTimeout(function(){HideFullScreenCenter();},3000);
        SetControllerVisibility(false);
        PreparePictureInPicture();
      };
      
      window.addEventListener("hashchange",function(){Start();},false);
      
      document.getElementsByTagName("video")[0].addEventListener("contextmenu", function(e){
        let canvas1=document.getElementsByTagName("canvas")[0];
        //let w=canvas1.width;
        let canvasStyle=window.getComputedStyle(canvas1);
        let w=parseInt(canvasStyle.width);
        let menu = document.getElementById("contextmenu");
        if(menu.classList.contains('show')) {
          menu.classList.remove('show');
        }
        while (menu.firstChild) menu.removeChild(menu.firstChild);
        let hittest=false;
        for(let i=0;i<Comments.length;i++){
          let comment=Comments[i];
          if(comment.lastDisplayed && comment.lastX * w < e.offsetX && e.offsetX < comment.lastX * w + comment.lastWidth * w
            && comment.lastYReal * w < e.offsetY && e.offsetY < comment.lastYReal * w + comment.lastHeight * w
            ){
            
            let text=comment.text;
            
            let p = document.createElement('p');
            p.innerText=text.replace(/\n/g, '↵');
            p.classList.add('title');
            menu.appendChild(p);
            
            if(comment.mail!=null && comment.mail != ""){
              let m = document.createElement('p');
              m.innerText=""+comment.mail;
              m.classList.add('menu');
              menu.appendChild(m);
            }
            
            let a = document.createElement('p');
            a.innerText="コメントをコピー";
            a.classList.add('menu');
            a.addEventListener("click", (function(p){
              return function(){
                document.getSelection().selectAllChildren(p);
                document.execCommand("copy");  
                if(menu.classList.contains('show')) {
                  menu.classList.remove('show');
                }
              }
              })(p),false);
            menu.appendChild(a);
            
            let gg = document.createElement('p');
            gg.classList.add('menu');
            gg.innerText="コメントで検索";
            gg.addEventListener("click", (function(text){
              return function(){
                if(menu.classList.contains('show')) {
                  menu.classList.remove('show');
                }
                window.open('https://www.google.co.jp/search?hl=ja&q='+encodeURI(text));
              }
              })(text),false);
            menu.appendChild(gg);
            
            hittest=true;
          }
        }
        if(hittest){
          menu.classList.add('show');
          let calcstyle=window.getComputedStyle(menu);
          menu.style.left=Math.max(Math.min(e.offsetX,parseInt(canvasStyle.width)-parseInt(calcstyle.width)-10),10)+"px";
          menu.style.top=Math.max(10,Math.min(e.offsetY,parseInt(canvasStyle.height)-parseInt(calcstyle.height)-10))+"px";
          preventDefault();
        }else{
          if(menu.classList.contains('show')) {
            menu.classList.remove('show');
          }
        }
      },false);
      //document.body.addEventListener('click',function(){
      document.getElementsByTagName("video")[0].addEventListener('click',function(){
        let menu = document.getElementById("contextmenu");
        if(menu.classList.contains('show')) {
          menu.classList.remove('show');
        }
      },false);
      function HideFullScreenCenter(){
        document.getElementById("toggle_fullscreen_center").style.display="none";
      }

      function Start(){
        let comment_org=CommentSource;
        let id=SetVideoLocation();

        if(id!="" && id!=null){
          UpdateLinkId(id);
          MovieId=id;
        }

        if(CommentSource!=comment_org){
          GetChatXML(function(xml) {
            Comments=ParseComment(xml);
            NotifyCommentUpdate(Comments);
            if(CommentTimer){clearInterval(CommentTimer);}
            CommentTimer=setInterval('DrawComment()', 1000.0/Fps);
          });
        }
      }
      function Coord(x,y){this.x=x;this.y=y;}
      document.onkeydown = function (e){OnKeyDown(e.keyCode,e.key);};
      function OnKeyDown(keyCode,key,preventDefault){
        let video1=document.getElementsByTagName("video")[0];
        if(keyCode==37 || keyCode==227 || key=="ArrowLeft" || key=="Left"){
          video1.currentTime-=10;
          ShowCurrentTime();
          preventDefault();
        }
        else if(keyCode==39 || keyCode==228 || key=="ArrowRight" || key=="Right"){
          video1.currentTime+=10;
          ShowCurrentTime();
          preventDefault();
        }
        else if(keyCode==38 || key=="ArrowUp" || key=="Up"){
          video1.volume=Math.min(video1.volume+0.05,1.0);
          ShowVolume();
          preventDefault();
        }
        else if(keyCode==40 || key=="ArrowDown" || key=="Down"){
          video1.volume=Math.max(video1.volume-0.05,0.0);
          ShowVolume();
          preventDefault();
        }
        else if(keyCode==32 || keyCode==179 || key=="Spacebar" || key==" " || key=="MediaPlayPause"){
          if(video1.paused){video1.play();}else{video1.pause();}
          preventDefault();
        }
        else if(key=="Play" && video1.paused){video1.play();preventDefault();}
        else if((key=="Pause" || key=="MediaPause") && !video1.paused){video1.pause();preventDefault();}
        else if(keyCode==67 || key=="c" || key=="ColorF2Yellow"){
          if(video1.controls){ToggleComment();}else{ToggleUi();}
          preventDefault();
        }
        else if(keyCode==77 || key=="m"){video1.muted=!video1.muted;preventDefault();}
        else if(keyCode==70 || key=="f"){ToggleFullScreenStatus();preventDefault();}
        else if(keyCode==86 || key=="v"){ToggleUi();preventDefault();}//動画を一時停止して観察する隠しモード
      }
      function PreparePictureInPicture(){
        let button=document.getElementById("toggle_pip");
        button.style.display=document.pictureInPictureEnabled?"inline-block":"none";
      }
      function TogglePictureInPicture(){
        let button=document.getElementById("toggle_pip");
        let video=document.getElementsByTagName("video")[0];
        if (!document.pictureInPictureElement) {
          video.requestPictureInPicture()
            .catch(error => {
            button.style.display="none";
            return;
          });
          //button.style.opacity=0.5;
        } else {
          document.exitPictureInPicture()
            .catch(error => {
            button.style.display="none";
            return;
          });
          //button.style.opacity=1.0;
        }
      }
      function ShowCurrentTime(){
        let video=document.getElementsByTagName("video")[0];
        let t = video.currentTime;
        let tx = GetTimespanText(t);
        SetMessageCanvas(tx,1000);
      }
      function GetTimespanText(sec){
        return (sec>=0?"":"-")+Math.floor(Math.abs(sec)/60)+":"+("00"+(Math.floor(Math.abs(sec))%60)).slice(-2);
      }
      function ShowVolume(){
        let video=document.getElementsByTagName("video")[0];
        SetMessageCanvas("音量: "+Math.round(video.volume*100)+"%",1000);
      }
      function ToggleFps(){
        if(Fps==60){Fps=15;}
        else if(Fps==15){Fps=24;}
        else if(Fps==24){Fps=30;}
        else if(Fps==30){Fps=60;}
        else{Fps=60;}
        localStorage.setItem("niconico_comment_Fps",Fps);
        SetFpsDisplay();
        clearInterval(CommentTimer);
        CommentTimer=setInterval('DrawComment()', 1000.0/Fps);
      }
      function SetFpsDisplay(){
        let abutton=document.getElementById("toggle_fps");
        abutton.innerText=Fps+"Fps";
      }
      var MoveBaseTime=-1;
      function SetTouchEvent(){
        let video1=document.getElementsByTagName("video")[0];
        let target=document.body;
        video1.addEventListener('touchstart', function(event) {
          /*video1.pause();*/
          if(MoveBaseTime==-1) {MoveBaseTime=video1.currentTime;}
          OriginalCoord=new Coord(event.changedTouches[0].pageX,event.changedTouches[0].pageY);
        },false);
        video1.addEventListener('touchmove', function(event) {
          event.preventDefault();
          if(MoveBaseTime==-1) {MoveBaseTime=video1.currentTime;}
          let currentCoord=new Coord(event.changedTouches[0].pageX,event.changedTouches[0].pageY);
          let sec=GetSecond(currentCoord,OriginalCoord);
          
          SetMessageCanvas((sec>=0?"+":"")+GetTimespanText(sec)+" ("+GetTimespanText(MoveBaseTime+sec)+")",0);
        },false);
        video1.addEventListener('touchend', function(event) {
          let currentCoord=new Coord(event.changedTouches[0].pageX,event.changedTouches[0].pageY);
          SetMessageCanvas("",0);
          let sec=GetSecond(currentCoord,OriginalCoord);
          if(Math.abs(sec)>0){
            video1.currentTime=MoveBaseTime+sec;
          }
          MoveBaseTime=-1;
          /*video1.play();*/
        },false);
      }
      function SetMessage(message){
          let msgp=document.getElementById("message");
          msgp.innerText=message;
          SetMessageCanvas(message,0);
      }
      function SetMessageCanvas(message,timespan){
          //SetMessage(message);
          CanvasMessage=message;
          if(timespan!=0){
            CanvasMessageDeadline=(new Date()).getTime()+timespan;
          }else{
            CanvasMessageDeadline=0;
          }
      }
      function ResizeOnPause(){
        let video=document.getElementsByTagName("video")[0];
        SetControllerVisibility(video.controls);
      }
      function ResizeOnPlay(){
        SetControllerVisibility(false);
      }
      function VolumeChange(from){
        let storage=localStorage;
        storage.setItem("niconico_volume",from.volume);
      }
      function GetSecond(orgcoord,crtcoord){
        return Math.floor(-(crtcoord.x-orgcoord.x)*0.1);
      }
      function SetControllerVisibility(visible){
        if(visible){
          document.getElementById("controller").style.display="inline";
        }else{
          document.getElementById("controller").style.display="none";
          //setTimeout(function(){document.getElementById("controller").style.display="none";},5000);
        }
      }
      function ToggleFullScreenStatus(){
        if(document.fullscreenElement == null && document.webkitFullscreenElement == null && document.mozFullScreenElement == null && document.msFullscreenElement == null){
          requestFullscreen();
          
          screen.lockOrientationUniversal = screen.lockOrientation || screen.mozLockOrientation || screen.msLockOrientation;
          if (screen.lockOrientationUniversal != null && screen.lockOrientationUniversal("landscape")) {
          }else if(screen.orientation.lock != null){
            screen.orientation.lock("landscape").then(function(){/* Locked */},function(/* Lock failed */){});
          }
        }else{
          exitFullscreen();
        }
      }
      function requestFullscreen() {
        let target=document.body;
        if (target.webkitRequestFullscreen) {
          target.webkitRequestFullscreen();
        } else if (target.mozRequestFullScreen) {
          target.mozRequestFullScreen();
        } else if (target.msRequestFullscreen) {
          target.msRequestFullscreen();
        } else if (target.requestFullscreen) {
          target.requestFullscreen();
        }
      }
      function exitFullscreen() {
        if (document.webkitCancelFullScreen) {
          document.webkitCancelFullScreen();
        } else if (document.mozCancelFullScreen) {
          document.mozCancelFullScreen();
        } else if (document.msExitFullscreen) {
          document.msExitFullscreen();
        } else if(document.cancelFullScreen) {
          document.cancelFullScreen();
        } else if(document.exitFullscreen) {
          document.exitFullscreen();
        }
      }
      function ToggleFullScreen(){
        FullScreenSetting=(FullScreenSetting+1)%3;

        if(FullScreenSetting==0){SetMessageCanvas("標準サイズ",3000);}
        else if(FullScreenSetting==1){SetMessageCanvas("最適表示",3000);}
        else if(FullScreenSetting==2){SetMessageCanvas("全体表示",3000);}

        ApplyFullScreenSetting();
      }
      function ApplyFullScreenSetting(){
        if(FullScreenSetting==1){SetSizeFullFixedUncontorolable();}
        else if(FullScreenSetting==2){SetSizeFull();}
        else{SetSizeDefault();}
      }
      function SetSizeFull(){
        let w=parent?parent.innerWidth:window.innerWidth;
        let h=parent?parent.innerHeight:window.innerHeight;
        SetSize(w,h);
      }
      function SetSizeFullFixedUncontorolable(){
        let w=parent?parent.innerWidth:window.innerWidth;
        let h=parent?parent.innerHeight:window.innerHeight;
        let ht=w*9.0/16.0;
        let hp=window.innerHeight;
        let hc=document.getElementById("controller").offsetHeight;
        if(ht>h){
          ht=h;
          w=ht*(16/9);
        }
        SetSize(w,ht);
      }
      function SetSizeDefault(){
        let w=parent?parent.innerWidth:window.innerWidth;
        let wm=Math.min(w,855);
        SetSize(wm,wm/855.0*481.0);
      }
      function SetSize(width,height){
        let videoDiv1= document.getElementById("VideoPlayer");
        let controler1= document.getElementById("controller");
        let canvas1=document.getElementsByTagName("canvas")[0];
        let video1=document.getElementsByTagName("video")[0];

        videoDiv1.style.width=width+"px";
        canvas1.style.width=width+"px";
        video1.style.width=width+"px";
        video1.width=width;
        canvas1.width=width*window.devicePixelRatio;

        videoDiv1.style.height=height+"px";
        canvas1.style.height=height+"px";
        video1.style.height=height+"px";
        video1.height=height;
        canvas1.height=height*window.devicePixelRatio;
        
        RequestSize(width,height);
      }
      function ToggleBackground(){
        if(Background=="black"){Background="white";}
        else if(Background=="white"){Background="black";}
        else{Background="black";}
        ApplyBackgroundSetting();
        localStorage.setItem("niconico_background",Background);
      }
      function ApplyBackgroundSetting(){
        document.body.style.backgroundColor=Background;
      }
      function ToggleUi(){
        let video=document.getElementsByTagName("video")[0];
        let menu = document.getElementById("contextmenu");
        
        if(menu.classList.contains('show')) {
          menu.classList.remove('show');
        }
        if(video.controls){
          if(ShowComment){ToggleComment();}
          video.controls=false;
          video.pause();
          SetMessageCanvas("UI非表示モード(vで切り替え)",1000);
        }else{
          ToggleComment();
          video.controls=true;
          video.play();
        }
        SetControllerVisibility(false);
      }
      function ToggleComment(){
        if(ShowComment){
          SetMessageCanvas("コメントオフ",1000);

          //document.getElementById("toggle_comment").innerText="コメントオフ";
          document.getElementById("toggle_comment").style.opacity=0.5;
          let canvas1=document.getElementsByTagName("canvas")[0];
          let context1=canvas1.getContext('2d');
          context1.clearRect(0,0,canvas1.width,canvas1.height);
        }
        else{
          //document.getElementById("toggle_comment").innerText="コメントオン";
          document.getElementById("toggle_comment").style.opacity=1.0;

          SetMessageCanvas("コメントオン",1000);
        }
        ShowComment=!ShowComment;
        localStorage.setItem("niconico_comment_enabled",ShowComment);
      }
      function UpdateLinkId(id){
        let link=document.getElementById("nicovideo_link");
        link.setAttribute("href", "https://www.nicovideo.jp/watch/"+id);
        link.style.display="inline-block";
      }
      function OpenInNicovideo(){
        if(MovieId){
          let video=document.getElementsByTagName("video")[0];
          let url = "http://www.nicovideo.jp/watch/"+MovieId+"?from="+Math.floor(video.currentTime);
          if(parent){parent.location.href=url;}else{window.location.href=url;}
          return true;
        }
        return false;
      }
      function CheckRanges(ranges,range){
        if(!ranges){return true;}
        for(let tr of ranges){
          if(tr.a<=range.b && range.a<tr.b){return false;}
        }
        return true;
      }
      function GetActualVpos(vpos,duration,cmDuration){
        return Math.min(vpos,duration*100-cmDuration*0.5);
      }
      function DrawComment(){
        let canvas1=document.getElementsByTagName("canvas")[0];
        let video1=document.getElementsByTagName("video")[0];
        let context1=canvas1.getContext('2d');
        context1.clearRect(0,0,canvas1.width,canvas1.height);

        let height=canvas1.width/855*30;
        let time=video1.currentTime;
        let fontWeight=600;
        let fontName="";

        let blurScale=0.3;

        if(CanvasMessage!="" && (CanvasMessageDeadline==0 || CanvasMessageDeadline>=(new Date()).getTime())){
          fontName='"ヒラギノ角ゴ ProN W6", HiraKakuProN-W6, "ヒラギノ角ゴ ProN", HiraKakuProN, "Hiragino Kaku Gothic ProN"'+','+'"ＭＳ Ｐゴシック", "MS PGothic", MSPGothic, MS-PGothic'+',Arial';
          context1.font=GetFontText(height,2,fontName,fontWeight);

          let mesWidth=context1.measureText(CanvasMessage).width;

          context1.textBaseline="middle";
          context1.fillStyle="#ffffff";
          context1.shadowColor="#000000";

          context1.shadowOffsetX=0;
          context1.shadowOffsetY=0;
          context1.shadowBlur=height*blurScale;
          context1.fillText(CanvasMessage,canvas1.width/2.0-mesWidth/2.0,canvas1.height/2.0);
          context1.globalAlpha=1.0;
          fontName="";
        }
        if(!ShowComment){return;}

        context1.font=GetFontText(height,1,fontName,fontWeight);

        let range=function(a,w){this.a=a;this.b=a+w;this.w=w;}
        let rangesUe=[];
        let rangesShita=[];
	        
        let cmDuration=CommentDuration;
        let operatedComments=[];
        for(let i=0;i<Comments.length;i++){
          let comment=Comments[i];
          comment.lastDisplayed=0;
          let commentText=comment.text.replace(/\\/g,"\u29F5").replace(/\t/g,'     ');
          let commentLines=commentText.split('\n');
          let cvpos=GetActualVpos(comment.vpos,video1.duration,cmDuration);
          if(time * 100-cmDuration<cvpos && cvpos < time *100 +cmDuration*0){
            if(comment.mail!=null && ContainsCommand(comment.mail,"invisible")){continue;}

            //enderの場合は基本コメントアートなのでオリジナルのフォントサイズを尊重(基本は小さめ)。
            //文字サイズが小さめなのは、ニコニコ動画創設時より画面サイズが大きくなったため。
            //参考:https://ch.nicovideo.jp/meg_nakagami/blomaga/ar218683
            let isender=ContainsCommand(comment.mail,"ender");
            let enderBase=canvas1.width/855;

            let heightScale=isender?enderBase*(855.0/25.4)/height:1;
            if(comment.fontScale>0){heightScale=comment.fontScale;}
            else if(comment.mail!=null && ContainsCommand(comment.mail,"small")){heightScale=isender?enderBase*(855.0/38.0)/height:0.6;}
            else if(comment.mail!=null && ContainsCommand(comment.mail,"big")){heightScale=isender?enderBase*(855.0/16.0)/height:1.5;}
            if(!isender){
              heightScale=Math.min(heightScale,canvas1.height / (height*commentLines.length));
            }

            if(comment.mail!=null && ContainsCommand(comment.mail,"mincho")){
              fontName='"ヒラギノ明朝 ProN W3", HiraMinProN-W3, "ヒラギノ明朝 ProN", HiraMinProN, "Hiragino Mincho ProN"'+','+'"游明朝体", "游明朝", "Yu Mincho", YuMincho, yumincho, YuMin-Medium'+','+"'serif'";
              fontWeight=300;
            }else if(comment.mail!=null && ContainsCommand(comment.mail,"gothic")){
              fontName='"ヒラギノ角ゴシック", "Hiragino Sans", HiraginoSans'+','+'"游ゴシック体", "游ゴシック", "Yu Gothic", YuGothic, yugothic, YuGo-Medium'+','+'sans-serif';
              fontWeight=300;
            }else{
              fontName='"ヒラギノ角ゴ ProN W6", HiraKakuProN-W6, "ヒラギノ角ゴ ProN", HiraKakuProN, "Hiragino Kaku Gothic ProN"'+','+'"ＭＳ Ｐゴシック", "MS PGothic", MSPGothic, MS-PGothic'+',Arial';
              fontWeight=600;
            }

            context1.font=GetFontText(height,heightScale,fontName,fontWeight);
            let r=new Coordinate(0,0);
            let overflow=false;
            let modnum=(canvas1.height-height+1);
//            if(comment.width<0)
            comment.width=-1;
            for(let line of commentLines)
              {comment.width=Math.max(context1.measureText(line).width,comment.width);}
            if(comment.mail!=null && ContainsCommand(comment.mail,"ue")){
              r=new Coordinate(canvas1.width/2.0-comment.width/2.0,0);
              if(ContainsCommand(comment.mail,"ender")){}else{
              if(comment.lastY>=0){
                r.y=comment.lastY*canvas1.width;
              }
              let changed=false;
              while(! CheckRanges(rangesUe,new range(r.y,height*heightScale))){
                r.y+=height*heightScale;
                changed=true;
              }
              if(changed){
                for(let crtr of rangesUe){
                  if(crtr.b<r.y && CheckRanges(rangesUe,new range(crtr.b,height*heightScale))){
                    r.y=crtr.b;
                  }
                }
              }
              if(height*commentLines.length*heightScale>canvas1.height){
                r.y=0;
              }
              }
              comment.lastY=r.y/canvas1.width;
              let commentWidth=canvas1.width*(ContainsCommand(comment.mail,"full")?1:0.75);
              if(comment.width>commentWidth){
                heightScale=Math.min(heightScale*commentWidth/comment.width,heightScale);
                let fsize=Math.max(height*heightScale,1);
                heightScale=fsize/height;
                context1.font=GetFontText(fsize,1,fontName,fontWeight);
                comment.width=context1.measureText(comment.text).width;
                r.x=canvas1.width/2.0 - comment.width/2.0;
              }
              if(!ContainsCommand(comment.mail,"ender")){
                rangesUe.push(new range(r.y,commentLines.length*height*heightScale));
              }

              comment.lastYReal=r.y/canvas1.width;
              context1.textBaseline="top";
              if(r.y>modnum){overflow=true;r.y=r.y%modnum;}
            }
            else if(comment.mail!=null && ContainsCommand(comment.mail,"shita")){
              r=new Coordinate(canvas1.width/2.0-comment.width/2.0,0);
              if(ContainsCommand(comment.mail,"ender")){}else{
              if(comment.lastY>=0){
                r.y=comment.lastY*canvas1.width;
              }
              let changed=false;
              while(! CheckRanges(rangesShita,new range(r.y,height*heightScale))){
                r.y+=height*heightScale;
                changed=true;
              }
              if(changed){
                for(let crtr of rangesShita){
                  if(crtr.b<r.y && CheckRanges(rangesShita,new range(crtr.b,height*heightScale))){
                    r.y=crtr.b;
                  }
                }
              }
              if(height*commentLines.length*heightScale>canvas1.height){
                r.y=0;
              }
              }
              comment.lastY=r.y/canvas1.width;

              let commentWidth=canvas1.width*(ContainsCommand(comment.mail,"full")?1:0.75);
              if(comment.width>commentWidth){
                heightScale=Math.min(heightScale*commentWidth/comment.width,heightScale);
                context1.font=GetFontText(height,heightScale,fontName,fontWeight);
                comment.width=context1.measureText(comment.text).width;
                r.x=canvas1.width/2.0 - comment.width/2.0;
              }
/*
context1.rect(r.x,r.y+height,comment.width,-height*heightScale);
context1.stroke();
*/
              if(!ContainsCommand(comment.mail,"ender")){
                rangesShita.push(new range(r.y,commentLines.length*height*heightScale));
                //rangesShita.push(new range(r.y,height*heightScale));
              }

              if(r.y>modnum){overflow=true;r.y=r.y%modnum;}
              r.y=canvas1.height-r.y-(commentLines.length-1)*height*heightScale;
              comment.lastYReal=(r.y-height*heightScale)/canvas1.width;

              context1.textBaseline="bottom";
            }else{
              r=GetFromOperated(operatedComments,comment,video1.duration,cmDuration,time,canvas1.width,height,context1);
              comment.lastY=r.y/canvas1.width;
//              r.y+=height*(heightScale-1)/2.0;
              if(r.y>modnum){overflow=true;r.y=r.y%modnum;}
              r.y+=height/2.0;
              r.y=Math.max(r.y,height*heightScale/2.0);
              operatedComments.push(comment);
              context1.textBaseline="middle";
              comment.lastYReal=(r.y-height*heightScale/2.0)/canvas1.width;
//context1.rect(r.x,r.y,comment.width,height);
//context1.stroke();
            }
            comment.fontScale=heightScale;

            // コメントでバックスラッシュを意図しているが、円マークで表示される事があるので対策。
            // フォント切り替えなしでは全角しかないようなので\u29F5(REVERSE SOLIDUS OPERATOR)で代替
            //let commenttext=comment.text;
            context1.globalAlpha=overflow?0.7:1.0;
            let fillColor=GetColorFromMail(comment.mail);
            context1.fillStyle=fillColor;
            if(!overflow){
              context1.shadowColor= fillColor=="#000000" ? "#ffffff" : "#000000";
            }else{
              context1.shadowColor= "transparent";
            }
            context1.shadowOffsetX=0;
            context1.shadowOffsetY=0;
            context1.shadowBlur=height*blurScale;
            
            comment.lastX=r.x/canvas1.width;
            comment.lastWidth=comment.width/canvas1.width;
            comment.lastHeight=height*heightScale*commentLines.length/canvas1.width;
            comment.lastDisplayed=1;

            let lineCnt=0;
            for(let line of commentLines){
              context1.fillText(line,r.x,r.y+height*heightScale*lineCnt);
              lineCnt++;
            }
            context1.globalAlpha=1.0;
          }
        }
      }
      function GetFontText(height,heightScale,fontName,fontWeight){
        return fontWeight+" "+(height*heightScale)+"px "+fontName;
      }
      function GetFromOperated(operatedComments,comment,videoDuration,cmDuration,time,canvasWidth,fontHeight,testContext){
        let cvpos=GetActualVpos(comment.vpos,videoDuration,cmDuration);
 //       if(comment.lastY>=0){return new Coordinate(GetCommentX(cvpos,time*100,comment.width,canvasWidth,cmDuration),comment.lastY*canvasWidth);}
        let ry=Math.max(0,comment.lastY*canvasWidth);
        let firstCollision=true;
        for(let i=0;i<operatedComments.length;i++){
          let opCom=operatedComments[i];
          let cvpos2=GetActualVpos(opCom.vpos,videoDuration,cmDuration);
          let a=GetCommentX(cvpos,cvpos2+cmDuration,comment.width,canvasWidth,cmDuration);
          let b=GetCommentX(cvpos2,cvpos,opCom.width,canvasWidth,cmDuration) + opCom.width;
          let c=GetCommentX(cvpos2,cvpos+cmDuration,opCom.width,canvasWidth,cmDuration);
          let d=GetCommentX(cvpos,cvpos2,comment.width,canvasWidth,cmDuration) + comment.width;
          if(
            CheckY(fontHeight,ry,opCom.lastY*canvasWidth,comment.text.split('\n').length,opCom.text.split('\n').length) &&
                (! ( ( (b<canvasWidth) && (0<a) && (cvpos2<=cvpos) ) || ( (c<canvasWidth) && (0<d) && (cvpos<cvpos2) ) ) )
//                (! ( ( (b<canvasWidth) && (0<a) ) ) )
            ){
            i=-1;
            if(firstCollision){firstCollision=false;ry=0;}
            else{ry+=fontHeight;}
          }
        }
        let rx=GetCommentX(cvpos,time*100,comment.width,canvasWidth,cmDuration);
//debug
/*
if(!firstCollision){
testContext.rect(rx,ry,comment.width,fontHeight);
testContext.stroke();
}
*/
        return new Coordinate(rx,ry);
      }
      function GetCommentX(cvpos,time,width,canvasWidth,cmDuration){
        return (1-(time-cvpos)/cmDuration)*(canvasWidth+width)-width;
      }

      function ContainsCommand(mail,key){
        if(mail==null || mail==""){return false;}
        let mails=mail.split(" ");
        for(let i=0;i<mails.length;i++){
          if(mails[i]==key){return true;}
        }
        return false;
      }
      function GetColorFromMail(mail){
        if(mail==null || mail==""){return "#ffffff";}
        if(ContainsCommand(mail,"black")){return "#000000";}
        if(ContainsCommand(mail,"red")){return "#ff0000";}
        if(ContainsCommand(mail,"pink")){return "#FF8080";}
        if(ContainsCommand(mail,"orange")){return "#FFC000";}
        if(ContainsCommand(mail,"yellow")){return "#FFFF00";}
        if(ContainsCommand(mail,"green")){return "#00FF00";}
        if(ContainsCommand(mail,"cyan")){return "#00FFFF";}
        if(ContainsCommand(mail,"blue")){return "#0000ff";}
        if(ContainsCommand(mail,"purple")){return "#c000ff";}
        if(ContainsCommand(mail,"white")){return "#ffffff";}

        if(ContainsCommand(mail,"white2") || ContainsCommand(mail,"niconicowhite")){return "#cccc99";}
        if(ContainsCommand(mail,"red2") || ContainsCommand(mail,"truered")){return "#cc0033";}
        if(ContainsCommand(mail,"pink2")){return "#ff33cc";}
        if(ContainsCommand(mail,"orange2") || ContainsCommand(mail,"passionorange")){return "#ff6600";}
        if(ContainsCommand(mail,"yellow2") || ContainsCommand(mail,"madyellow")){return "#999900";}
        if(ContainsCommand(mail,"green2") || ContainsCommand(mail,"elementalgreen")){return "#00cc66";}
        if(ContainsCommand(mail,"cyan2")){return "#00cccc";}
        if(ContainsCommand(mail,"blue2") || ContainsCommand(mail,"marineblue")){return "#3399ff";}
        if(ContainsCommand(mail,"purple2") || ContainsCommand(mail,"nobleviolet")){return "#6633cc";}
        if(ContainsCommand(mail,"black2")){return "#666666";}
        
        if(mail==null || mail==""){return false;}
        let reg=new RegExp(/#[0-9A-fA-F]{6}/);
        let mails=mail.split(" ");
        for(let i=0;i<mails.length;i++){
          if(reg.test(mails[i])){return mails[i];}
        }

        return "#ffffff";
      }
      function Coordinate(x,y){this.x=x;this.y=y;}
      function CheckY(fontHeight,y1,y2,lineCnt1,lineCnt2){
        return y1-fontHeight*(lineCnt2-0.5) < y2 && y2-fontHeight*(lineCnt1-0.5) < y1;
      }
      function ParseComment(xml){
        let result=[];
        let parser = new DOMParser();
        let dom=parser.parseFromString(xml, 'text/xml');
        let chats=dom.getElementsByTagName("chat");
        for(let i=0 ; i < chats.length;i++){
          let chat=function(text,vpos,mail,cnt){
            this.text=text;
            this.vpos=vpos;
            if(mail!=null){
              this.mail=mail.toLowerCase();
            }else{
              this.mail=mail;
            }
            this.count=cnt;
            this.lastY=-1;
            this.width=-1;
            this.lastCnt=-1;
            this.fontScale=-1;
            //for contextmenu
            this.lastYReal=-1;
            this.lastX=-1;
            this.lastWidth=-1;
            this.lastDisplayed=0;
            this.lastHeight=-1;
          }
          let chatT=chats[i];
          let atdeleted=chats[i].getAttribute("deleted");
          if(atdeleted==0 || atdeleted==null){
            result.push(new chat(chats[i].textContent,chats[i].getAttribute("vpos"),chats[i].getAttribute("mail"),i));
          }
        }
        result.sort(function(a,b){
          if(a.vpos==b.vpos){return a.count>b.count?1:-1;}
          return a.vpos-b.vpos;
        });
        return result;
      }
      function GetChatXML(callback){
        let req = new XMLHttpRequest();
        req.onreadystatechange = function() {
          if (req.readyState == 4) {
            if (req.status == 200) {
              callback(req.responseText);
              }
            }
          }
        req.open('GET',CommentSource,true);
        req.send(null);
      }

      function NotifyCommentUpdate(comment){
        if(window.parent){
          let message={};
          message.message="comment_updated";
          message.comment=comment;
          window.parent.postMessage(message, self.origin);
        }
      }

      function RequestSize(width,height){
        if(window.parent){
          let message={};
          message.message="request_size";
          message.width=width;
          message.height=height;
          window.parent.postMessage(message, self.origin);
        }
      }
      
      function MovieEnded(){
        if(window.parent){
          let message={};
          message.message="movie_ended";
          window.parent.postMessage(message, self.origin);
        }
      }
//]]>
    </script>
  </body>
</html>

